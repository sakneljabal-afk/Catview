<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ูุนุจุฉ ุงููุฏูุน ูุงูููุงุนุงุช</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

<style>
  /* === ุชูุณููุงุช ุดุงุดุฉ ุงูููุงูุฉ (ููุชุจุณุฉ ูู CarRace.html) === */
  .summary-overlay {
      position: fixed; 
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      display: none; 
      justify-content: center;
      align-items: center;
      z-index: 5000;
  }

  .summary-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
      border: 4px solid #f72585;
      width: 95%;
      max-width: 750px;
      max-height: 95vh;
      display: flex;
      flex-direction: column;
      text-align: center;
  }

  .scrollable-review {
      overflow-y: auto;
      max-height: calc(95vh - 120px);
      margin: 5px 0;
      padding: 8px;
      border: 1px dashed #4cc9f0;
      text-align: right;
      line-height: 1.8;
      font-size: 22px;
      white-space: pre-wrap;
      color: #fff;
  }

  .summary-content h2 {
      font-size: 32px;
      color: #4cc9f0;
      margin-bottom: 5px;
  }

  .summary-content p {
      font-size: 24px;
      color: #2ecc71;
      font-weight: bold;
      margin-bottom: 5px;
  }

  .summary-content h3 {
      font-size: 20px;
      color: #fff;
      border-bottom: 1px solid #fff;
      padding-bottom: 3px;
  }

  .modal-btn {
      display: block;
      width: 80%;
      margin: 20px auto 0;
      padding: 15px 20px;
      background-color: #f72585;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.4rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
  }

  .modal-btn:hover {
      background-color: #d11c70;
  }
  
  /* === ุชูุณููุงุช ุงูุตูุญุฉ ุงูุนุงูุฉ === */
  body {
    margin: 0;
    /* ุฎูููุฉ ุจุฑุชูุงููุฉ ุฏุงูุฆุฉ ูููุงุณุจุฉ ููุทูู 12 ุณูุฉ */
    background: linear-gradient(135deg, #FFD580 0%, #FFB347 100%);
    font-family: 'Segoe UI', 'Tajawal', Tahoma, Geneva, Verdana, sans-serif;
    /* ููู ูุชุนุทูู ุงูุฅููุงุกุงุช ุบูุฑ ุงููุฑุบูุจ ูููุง ุนูู ุงูููุจุงูู */
    touch-action: none;  
    overflow: hidden;  
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* === ุฑุฃุณ ุงูุตูุญุฉ (ุงูุณุคุงู) === */
  header {
    background: #2c3e50;  
    color: #fff;
    text-align: center;
    padding: 10px 15px; /* ุชู ุชูููู ุงูุจุงุฏููุฌ */
    
    /* ๐ ุงูุญู ุงูุฌุฐุฑู: ุชุซุจูุช ุงุฑุชูุงุน ุงูุฑุฃุณ ูู 40% ูู ุงุฑุชูุงุน ุงูุดุงุดุฉ */
    height: 40vh; 
    min-height: 40vh;
    max-height: 40vh; 
    
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* ูุจุฏุฃ ุงููุญุชูู ูู ุงูุฃุนูู */
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 10;
    
    /* ๐ ุงูุญู ุงูุฌุฐุฑู: ููุน ุงูุชูุฑูุฑ ููุงุฆูุงู */
    overflow-y: hidden; 
  }

  header h3 {
    margin: 5px 0 5px 0; /* ุชู ุชูููู ุงูููุงูุด */
    /* ๐ ุงูุชุนุฏูู: ููุงุณ ุฎุท ูุฑู ูููุงุณุจ ูู 40% ูู ุงูุดุงุดุฉ */
    font-size: clamp(1.6rem, 5vw, 2.2rem);  
    color: #FFD700;
    font-weight: bold;
    line-height: 1.3;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }

 .answers {
ย ย /* ๐ ุงูุญู ุงูุฌุฐุฑู: ุงุณุชุฎุฏุงู ููููุณ ูุชูุฒูุน ุงูุฎูุงุฑุงุช ุนูู ุงููุณุงุญุฉ ุงููุชุงุญุฉ */
ย ย flex-grow: 1;ย
ย ย display: flex;
ย ย flex-direction: column; /* ุชุฑุชูุจ ุงูุฎูุงุฑุงุช ุนููุฏูุงู */
ย ย 
ย ย /* โ ุงูุชุตุญูุญ 1: ุถุจุท ุงููุณุงูุฉ ุจูู ุงูุนูุงุตุฑ ูู 5 ุจูุณู ุซุงุจุชุฉ */
ย ย gap: 5px; 
ย ย 
ย ย /* โ ุงูุชุตุญูุญ 2: ุชุฑู ุงูุชูุฒูุน ูุจุฏุฃ ูู ุงูุฃุนูู (ูููุน ุงูุชูุฏุฏ ุงูุนุดูุงุฆู) */
ย ย justify-content: flex-start;ย
ย ย 
ย ย text-align: right;ยย
ย ย padding: 5px 10px; 
ย ย margin-top: 5px; 
ย ย overflow-y: hidden; 
ย }
  
 .answers span {
ย ย display: block;ยย
ย ย /* ๐ ุงูุชุนุฏูู: ููุงุณ ุฎุท ูุฑู ูููุงุณุจ */
ย ย font-size: clamp(1.2rem, 4vw, 1.8rem);ยย
ย ย margin: 0; /* โ ุชู ุฅุฒุงูุฉ ุงูููุงูุด ุงูุนููุฏูุฉ ุญูุซ ุชู ุงุณุชุจุฏุงููุง ุจู gap */
ย ย padding: 6px 10px;
ย ย border-bottom: 1px solid rgba(255,255,255,0.2); 
ย ย background-color: rgba(255, 255, 255, 0.1);
ย ย border-radius: 8px;
ย ย font-weight: 600;
ย ย line-height: 1.4;
ย ย 
ย ย /* โ ุงูุชุตุญูุญ 3: ุงูุณูุงุญ ูููุต ุจุงูุงูุชูุงู ุนูู ุณุทุฑูู ุฃู ุฃูุซุฑ */
ย ย white-space: normal; 
ย ย height: auto; 
ย ย 
ย ย overflow: hidden;ย
ย ย text-overflow: ellipsis; 
ย }
  
  .answers span:last-child {
      border-bottom: none;
  }

  /* === ููุทูุฉ ุงููุนุจุฉ (Main) === */
  main {
    /* ๐ ุงูุญู ุงูุฌุฐุฑู: ุชุซุจูุช ุงุฑุชูุงุน ููุทูุฉ ุงููุนุจุฉ ูู 60% */
    flex: 1;  
    height: 60vh;
    max-height: 60vh;
    min-height: 60vh;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    padding: 5px; /* ุชู ุชูููู ุงูุจุงุฏููุฌ */
  }

  /* ุงูุฅุทุงุฑ ุงูุฎุงุฑุฌู ููุนุจุฉ */
  #game-frame {
    width: 95vw;  
    /* ๐ ุงูุญู ุงูุฌุฐุฑู: ุฌุนู ุงุฑุชูุงุน ุงูุฅุทุงุฑ ูููุฃ ุงูู 60% ุงููุชุงุญุฉ */
    height: 100%; 
    flex-grow: 1; 
    max-width: 700px;  
    /* ุฎูููุฉ ุจุฑุชูุงููุฉ ุฎูููุฉ ูููุงุณุจุฉ ููุฃุทูุงู */
    background: #E8F5E9;  
    /* ุฅุทุงุฑ ุฎุงุฑุฌู ูููู ูุฌุฐุงุจ ููุฃุทูุงู */
    border: 10px solid #FF8C42; /* ุชู ุชูููู ุณูู ุงูุฅุทุงุฑ */
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }

  #game-container {
    width: 100%;
    height: 100%;
  }

  /* === ูุคุซุฑุงุช ุงูุฎุทุฃ === */
  #wrongFlash {
    position: fixed;
    inset: 0;
    background: rgba(255, 0, 0, 0);
    pointer-events: none;
    transition: background 0.2s;
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* ุนูุงูุฉ ุงูุฎุทุฃ ุงููุจูุฑุฉ */
  #errorMark {
    font-size: 10rem;
    color: white;
    background: rgba(231, 76, 60, 0.9);
    width: 180px;
    height: 180px;
    border-radius: 50%;
    display: none;  
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 30px rgba(0,0,0,0.4);
    border: 8px solid white;
    font-weight: bold;
  }

  /* ุชุฃุซูุฑุงุช ุชูุงุนููุฉ ููุฎูุงุฑุงุช ุนูุฏ ุงูููุณ */
  @media (hover: hover) {
    .answers span:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: scale(1.02);
      transition: transform 0.2s;
    }
  }

  /* ุชุญุณููุงุช ููุดุงุดุงุช ุงูุตุบูุฑุฉ ุฌุฏุงู */
  @media (max-width: 480px) {
    header {
      height: 40vh; /* ุชุซุจูุช ุงูุงุฑุชูุงุน ูู 40% */
      min-height: 40vh;  
      padding: 10px 8px; /* ุชุนุฏูู ุงูุจุงุฏููุฌ */
    }
    
    header h3 {
      font-size: clamp(1.4rem, 4.5vw, 2.0rem);
    }
    
    .answers span {
      font-size: clamp(1.1rem, 3.5vw, 1.6rem);
      padding: 5px 8px;
    }

    main {
      height: 60vh; /* ุชุซุจูุช ุงูุงุฑุชูุงุน ูู 60% */
      max-height: 60vh;
      min-height: 60vh;
    }
    
    #game-frame {
      height: 100%; /* ูุฌุจ ุฃู ูููุฃ ุงูุฅุทุงุฑ ูุณุงุญุฉ ุงูู main */
      flex-grow: 1;
      border-width: 8px;
    }
  }

  /* === ุชูุณููุงุช ุดุงุดุฉ ุงูุชูุฏูู ุงูุฌุฏูุฏุฉ === */
  #introScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); /* ุฎูููุฉ ุฎุถุฑุงุก ุฌุฐุงุจุฉ */
      z-index: 1000; /* ุฃุนูู ูู ูู ุดูุก */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: white;
      text-align: center;
      transition: opacity 0.5s ease;
      opacity: 1;
  }
  
  #introScreen.hidden {
      opacity: 0;
      pointer-events: none;
  }

  .intro-content {
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 20px; /* ุชู ุชูููู ุงูุจุงุฏููุฌ ููููุงู */
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      
      /* โ ุงูุชุนุฏูู ุงูุฌุฏูุฏ ูุฌุนููุง ููุงุณุจุฉ ููููุจุงูู */
      max-height: 90vh; 
      overflow-y: auto; 
      box-sizing: border-box; 
  }

  .intro-content h2 {
      color: #FF8C42;
      font-size: clamp(2rem, 6vw, 3rem);
      margin-top: 0;
      border-bottom: 3px solid #FF8C42;
      padding-bottom: 10px;
      margin-bottom: 20px;
  }

  .intro-content p {
      /* โ ุชุนุฏูู ุญุฌู ุงูุฎุท ููููู ุฃูุซุฑ ูุฑููุฉ */
      font-size: clamp(1rem, 3.5vw, 1.4rem); 
      line-height: 1.6;
      margin-bottom: 15px;
      text-align: right;
  }
  
  .intro-content ul {
      list-style-type: none;
      padding: 0;
      text-align: right;
  }
  
  .intro-content ul li {
      background: #e8f5e9;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-weight: 600;
      border-right: 4px solid #3498db;
      text-align: right;
      /* โ ุชุนุฏูู ุญุฌู ุฎุท ุงููุงุฆูุฉ */
      font-size: clamp(0.95rem, 3.2vw, 1.3rem); 
  }

  #startButton {
      background: #FF8C42;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.5rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 25px;
      box-shadow: 0 5px 0 #d35400;
      transition: all 0.1s ease;
  }

  #startButton:active {
      transform: translateY(5px);
      box-shadow: 0 0 0 #d35400;
  }
</style>
</head>

<body>

<div id="introScreen">
    <div class="intro-content">
        <h2>๐ ูุนุจุฉ ุงููุฏูุน ูุงูููุงุนุงุช</h2>
        <p>ูุฑุญุจุงู ุฃููุง ุงูุจุทู! ูู ุฃูุช ูุณุชุนุฏ ูุงุฎุชุจุงุฑ ูุนูููุงุชู ุงูุนูููุฉ ูู ุชุญุฏู ููุชุนุ</p>
        
        <h3>๐ ุงููุฏู ูู ุงููุนุจุฉ</h3>
        <ul>
            <li>**ุงูุชุนูู ูุงููุฑุงุฌุนุฉ:** ุชุซุจูุช ูุนูููุงุชู ุงูุฏุฑุงุณูุฉ ูุงุฎุชุจุงุฑูุง.</li>
            <li>**ุงูุงุณุชูุชุงุน:** ูุถุงุก ููุช ููุชุน ููุณูู!</li>
        </ul>
        
        <h3>๐ฏ ุทุฑููุฉ ุงููุนุจ</h3>
        <ul>
            <li>**ุงูุฅุฌุงุจุฉ ุฃููุงู:** ุงูุฑุฃ ุงูุณุคุงู ูุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ ูู ุงูุฃุนูู.</li>
            <li>**ุงูุชุตููุจ:** ุญุฑู ูุคุดุฑ ุงููุงูุณ (ุฃู ุฅุตุจุนู) ูุชุญุฏูุฏ ุฒุงููุฉ ุฅุทูุงู ุงููุฏูุน.</li>
            <li>**ุงูุฅุทูุงู:** ุงููุฑ/ุงููุณ ูุฅุทูุงู ูุฐููุฉ.</li>
            <li>**ุตูุจ ุนูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ:** ูุฌุจ ุฃู ุชุตูุจ ุงูููุงุนุฉ ุงูุชู ุชุญูู ุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (1 ุฃู 2 ุฃู 3).</li>
            <li>**ุงูููุงุท:** ูู ุฅุฌุงุจุฉ ุตุญูุญุฉ ุชููุญู **10 ููุงุท**.</li>
            <li>**ุงูุฎุทุฃ:** ุฅุฐุง ุฃุทููุช ุนูู ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ ุฃู ุฃุฎุทุฃุช ูุฑุชูู ูุชุชุงููุชููุ ุณุชููุฏ ูุญุงููุฉ ูุณุชุนูุฏ ูู ุงูุฃุณุฆูุฉ ุงูุชู ุฃุฎุทุฃุช ูููุง ูู ุงูููุงูุฉ ูููุฑุงุฌุนุฉ.</li>
            <li>**ุงููุฏู:** ุฌูุน ุฃูุจุฑ ุนุฏุฏ ูู ุงูููุงุท ูุจู ุงูุชูุงุก ุฌููุน ุงูุฃุณุฆูุฉ!</li>
        </ul>
        
        <button id="startButton">ุงุจุฏุฃ ุงูุชุญุฏู</button>
    </div>
</div>

<header id="questionHeader">
    </header>

<main>
    <div id="game-frame">
        <div id="score-display" style="position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 1.2rem; border: 2px solid #FFD700; z-index: 100;">
            ุงูููุงุท: <span>0</span>
        </div>
        <div id="game-container"></div>
    </div>
</main>

<div id="wrongFlash">
    <div id="errorMark">โ</div>
</div>

<div class="summary-overlay" id="summaryOverlay">
    <div class="summary-content">
        <h2 id="summaryTitle"></h2>
        <p id="summaryScore"></p>
        <h3>ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ ูุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ:</h3>
        <div class="scrollable-review" id="scrollableReview">
        </div>
        <button class="modal-btn" id="restartBtn">๐ ุญุณูุงูุ ุฃุนุฏ ุงููุนุจ</button>
    </div>
</div>
<script>

/* ====================== 1. ุจูุงูุงุช ุงูุฃุณุฆูุฉ ====================== */
// o = Options (ุงูุฎูุงุฑุงุช), a = Answer (ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ - ุชุจุฏุฃ ูู 0)
const QUESTIONS = [
    { "id": 1, "q": "ุชุนูุด ุดุฌุฑุฉ ุงููุงูุฌุฑูู ูู ุจูุฆุฉ ุงูููุงู ุงููุงูุญุฉุ ูููุฐุง ุชูุชูู ุชูููุงู ุชุฑููุจูุงู ูู:", "o": [ "ุฃูุฑุงู ุนุฑูุถุฉ ุชุทูู ุนูู ุงููุงุก", "ุฌุฐูุฑ ูุตูุฑุฉ ุถุนููุฉ", "ุฌุฐูุฑ ุทูููุฉ ููููุฉ ูููุงููุฉ ุงูุฃููุงุฌ" ], "a": 2 },
    { "id": 2, "q": "ูุง ูู ูุธููุฉ ุงูุฌุฐูุฑ ุงูุทูููุฉ ูุงููููุฉ ูุดุฌุฑุฉ ุงููุงูุฌุฑููุ", "o": [ "ุชุฎุฒูู ูููุงุช ูุจูุฑุฉ ูู ุงููุงุก", "ุงูุชุตุงุต ุงูุถูุก ูู ุณุทุญ ุงููุงุก", "ุงูุตููุฏ ุฃูุงู ุงูุฃููุงุฌ ุงููููุฉ" ], "a": 2 },
    { "id": 3, "q": "ุงูุจูุฆุฉ ุงูุชู ูููู ูููุง ูุจุงุช ุฒูุจู ุงููุงุก (ุงูููุชุณ) ูู ุงููุณุชููุนุงุชุ ูุชุชููุฒ ูุฐู ุงูุจูุฆุฉ ุจู:", "o": [ "ููุงู ูุงูุญุฉ ูุฃููุงุฌ ูููุฉ", "ุชุฑุจุฉ ุฌุงูุฉ ูุฏุฑุฌุงุช ุญุฑุงุฑุฉ ูุฑุชูุนุฉ", "ููุงู ุฑุงูุฏุฉ ููููุงุช ูุจูุฑุฉ ูู ุงูุทูู" ], "a": 2 },
    { "id": 4, "q": "ููุชูู ูุจุงุช ุฒูุจู ุงููุงุก ุฃูุฑุงูุงู ุนุฑูุถุฉ ุชุทูู ุนูู ุณุทุญ ุงููุงุกุ ููุฐุง ุงูุชููู ุงูุชุฑููุจู ูุณุงุนุฏู ุนูู:", "o": [ "ููุงููุฉ ุงูุชูุงุฑุงุช ุงููุงุฆูุฉ", "ุชุฎุฒูู ุงููุงุก ุงูุฒุงุฆุฏ", "ุงูุชุตุงุต ูุฏุฑ ูุจูุฑ ูู ุถูุก ุงูุดูุณ" ], "a": 2 },
    { "id": 5, "q": "ูุง ูู ุงูุจูุฆุฉ ุงูุชู ุชุชููู ุดุฌุฑุฉ ุงูุตููุจุฑ ููุนูุด ูููุงุ", "o": [ "ุงููุณุชููุนุงุช ุงููุงุฆูุฉ", "ุงูุตุญุงุฑู ุงูุฌุงูุฉ", "ุงูููุงุทู ุงูุซูุฌูุฉ ุดุฏูุฏุฉ ุงูุจุฑูุฏุฉ" ], "a": 2 },
    { "id": 6, "q": "ุชููู ุดุฌุฑุฉ ุงูุตููุจุฑ ุนูู ุดูู ูุซูุซุ ููุฐุง ุงูุชููู ุงูุชุฑููุจู ูุณูุญ ุจู:", "o": [ "ุฌุฐุจ ุงููุฒูุฏ ูู ุถูุก ุงูุดูุณ", "ุฒูุงุฏุฉ ุณุฑุนุฉ ููู ุงูุฃุบุตุงู", "ุณูููุฉ ุงูุฒูุงู ุงูุซูุฌ ูู ุนูููุง ุฏูู ูุณุฑ ุงููุฑูุน" ], "a": 2 }
];

/* ====================== 2. ุฅุนุฏุงุฏุงุช ุงููุนุจุฉ (Phaser) ====================== */
const config = {
    type: Phaser.AUTO,
    parent: 'game-container',
    width: 600,
    height: 800,
    // ููู ุฎูููุฉ ุจุฑุชูุงูู ุฎููู ูููุงุณุจ ููุฃุทูุงู
    backgroundColor: '#E8F5E9', 
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload,
        create,
        update
    }
};

const game = new Phaser.Game(config);

/* ====================== 3. ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ====================== */
let cannon, bubbles, invisibleWall, aimLine;
let shootSound, correctSound, wrongSound, winSound;
let currentQ = 0;
let newCorrectIndex = 0;
let canShoot = true;
const BUBBLE_IMG_SIZE = 300; 
let missedShots = 0;
const totalQuestions = QUESTIONS.length; 
let score = 0; 
let wrongQuestions = []; 
let gameFinished = false; 
let scoreDisplay; 

/* ====================== 4. ุงูุชุญููู (Preload) ====================== */
function preload() {
    // ุชุนุฏูู ุงููุณุงุฑ ููุง ุฅูู 'assets/' ููุชูุงูู ูุน ุงูุชุญูููุงุช ุงูุฃุฎุฑู ูู ุงูููุฏ ุงูุฃุตูู
    this.load.image('cannon','assets/cannon.png');
    this.load.image('shoot','assets/shoot.png');
    this.load.image('bubble1','assets/bubble1.png');
    this.load.image('bubble2','assets/bubble2.png');
    this.load.image('bubble3','assets/bubble3.png');
    this.load.audio('correct','../assets/correct.mp3');
    this.load.audio('wrong','../assets/wrong.mp3');
    this.load.audio('win','../assets/win.mp3');
}

/* ====================== 5. ุงูุฅูุดุงุก (Create) ====================== */
function create(){
    const width = this.scale.width;
    const height = this.scale.height;

    // โฌ๏ธ ุฅุถุงูุฉ ุนุฑุถ ุงูููุงุท ุนูู ุงูุดุงุดุฉ (ูู DOM) โฌ๏ธ
    scoreDisplay = document.getElementById('score-display').querySelector('span');
    scoreDisplay.textContent = '0';
    
    // โฌ๏ธ ุงูุชุญูู ูู ุงูุชูุงุก ุงููุนุจุฉ โฌ๏ธ
    if (currentQ >= totalQuestions && wrongQuestions.length === 0) {
        gameOver(this, true); 
        return;
    }

    // ุชููุฆุฉ ุงูุฃุตูุงุช
    this.correctSound = this.sound.add('correct');
    this.wrongSound = this.sound.add('wrong');
    this.winSound = this.sound.add('win');

    this.physics.world.setBounds(0, 0, width, height);

    invisibleWall = this.add.rectangle(width/2, height * 0.55, width, 20, 0x000000, 0);
    this.physics.add.existing(invisibleWall, true);

    const cannonHeight = height * 0.10;
    const cannonScale = cannonHeight / 300; 
    
    // ุชู ุชุบููุฑ ููุถุน ุงููุฏูุน ุงูุนููุฏู ูู 0.90 ุฅูู 0.95
    cannon = this.add.sprite(width/2, height * 0.8, 'cannon')
        .setScale(cannonScale)
        .setDepth(1);

    bubbles = this.physics.add.group({
        collideWorldBounds: true,
        bounceX: 1,
        bounceY: 1
    });

    this.physics.add.collider(bubbles, invisibleWall);

    aimLine = this.add.graphics({ 
        lineStyle: { width: 4, color: 0xFF5722, alpha: 0.8 } 
    }).setDepth(2);

    this.input.on('pointermove', (pointer) => {
        updateAimLine(this, pointer);
    });

    this.input.on('pointerdown', (pointer) => {
        if (canShoot) updateAimLine(this, pointer);
    });

    this.input.on('pointerup', () => {
        if (canShoot) fire(this);
    });

    // ุฅุธูุงุฑ ุงูุณุคุงู ุนูุฏ ุจุฏุก ุงููุนุจ
    showQuestion(this);
}

/* ====================== 6. ุชุญุฏูุซ (Update) ====================== */
function update(){
    // ูุง ููุฌุฏ ุชุญุฏูุซ ุญุฑูู ูุณุชูุฑ ูุทููุจ ูู ูุฐู ุงููุนุจุฉ
}

/* ====================== 6.1 ูุธุงุฆู ูุณุงุนุฏุฉ ====================== */

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function wrongFlash(){
    const wrongFlashDiv = document.getElementById('wrongFlash');
    const errorMark = document.getElementById('errorMark');
    wrongFlashDiv.style.background = 'rgba(255, 0, 0, 0.4)';
    errorMark.style.display = 'flex';
    setTimeout(() => {
        wrongFlashDiv.style.background = 'rgba(255, 0, 0, 0)';
        errorMark.style.display = 'none';
    }, 500);
}

function updateAimLine(scene, pointer) {
    aimLine.clear();
    const angle = Phaser.Math.Angle.Between(cannon.x, cannon.y, pointer.x, pointer.y);
    const distance = 300;
    const x2 = cannon.x + Math.cos(angle) * distance;
    const y2 = cannon.y + Math.sin(angle) * distance;
    
    // ุฑุณู ุฎุท ุงูุชูุฏูู
    aimLine.lineStyle(4, 0xFF5722, 0.8);
    aimLine.beginPath();
    aimLine.moveTo(cannon.x, cannon.y);
    aimLine.lineTo(x2, y2);
    aimLine.strokePath();
}

function fire(scene) {
    canShoot = false;
    aimLine.clear();
    
    const pointer = scene.input.activePointer;
    const shootAngle = Phaser.Math.Angle.Between(cannon.x, cannon.y, pointer.x, pointer.y);
    
    // ูุง ุชุณูุญ ุจุงูุฅุทูุงู ููุฃุณูู
    if (shootAngle > 0.5 * Math.PI || shootAngle < -1.5 * Math.PI) {
        canShoot = true; 
        return;
    }

    const shotScale = (scene.scale.width * 0.12) / 300;
    const shot = scene.physics.add.sprite(
        cannon.x, 
        cannon.y - cannon.displayHeight/1.5, 
        'shoot'
    ).setScale(shotScale);

    // ุชุทุจูู ุงูุณุฑุนุฉ ุจุงุณุชุฎุฏุงู ุงูุฒุงููุฉ ุงููุญุณูุจุฉ
    const speed = 800; // ุณุฑุนุฉ ุงูุฅุทูุงู
    const velocityX = Math.cos(shootAngle) * speed;
    const velocityY = Math.sin(shootAngle) * speed;
    
    shot.setVelocity(velocityX, velocityY);

    scene.physics.add.overlap(shot, bubbles, (s, b) => {
        s.destroy();
        missedShots = 0;
        bubbleHit(scene, b);
    });

    shot.setCollideWorldBounds(true);
    shot.body.onWorldBounds = true;
    shot.body.world.on('worldbounds', (body) => {
        if (body.gameObject === shot) {
            shot.destroy();
            missedShots++;
            if (missedShots >= 2) {
                missedShots = 0;
                showQuestion(scene);
            }
        }
    });

    scene.time.delayedCall(1200, () => {
        if(shot.active) shot.destroy();
    });
    
    scene.time.delayedCall(800, () => {
        canShoot = true;
    });
}

/* ====================== 7. ุนุฑุถ ุงูุฃุณุฆูุฉ ูุงูููุงุนุงุช (showQuestion) ====================== */
function showQuestion(scene){
    if (gameFinished) return;

    let q;
    
    // โฌ๏ธ ุฃููุงู: ุนุฑุถ ุงูุฃุณุฆูุฉ ุงูุฎุงุทุฆุฉ ูููุฑุงุฌุนุฉ โฌ๏ธ
    if (wrongQuestions.length > 0) {
        q = wrongQuestions[0]; 
    } 
    // ุซุงููุงู: ุนุฑุถ ุงูุฃุณุฆูุฉ ุงูุนุงุฏูุฉ ุจุงูุชุณูุณู
    else if (currentQ < totalQuestions) {
        q = QUESTIONS[currentQ];
    } 
    // ุซุงูุซุงู: ุฅุฐุง ุงูุชูุช ุฌููุน ุงูุฃุณุฆูุฉ
    else {
        gameOver(scene, true);
        return;
    }

    // ุฎูุท ุงูุฎูุงุฑุงุช
    const shuffledOptions = Phaser.Utils.Array.Shuffle([...q.o]);
    const correctOptionText = q.o[q.a];
    const newCorrectIndex = shuffledOptions.indexOf(correctOptionText);

    // ุฃููุงู ูุชูููุฒ ุงูุฎูุงุฑุงุช
    const colors = ['#81d4fa', '#a5d6a7', '#ffe082'];

    // ุจูุงุก ูุญุชูู ุงูุฎูุงุฑุงุช ูู ุงูู HTML (ูุณุชุฎุฏู ุงูุชุฑุชูุจ ุงูุนุดูุงุฆู)
    let answersHtml = '';
    for(let i = 0; i < shuffledOptions.length; i++) {
        answersHtml += `<span id="answer-${i+1}" style="color:${colors[i]}">${i + 1}: ${shuffledOptions[i]}</span>`;
    }

    document.getElementById('questionHeader').innerHTML = `
        <h3>${q.q}</h3>
        <div class="answers">
            ${answersHtml}
        </div>
    `;

    bubbles.clear(true, true);

    const width = scene.scale.width;
    const height = scene.scale.height;

    const bubbleTargetSize = width * 0.18;
    const bubbleScale = bubbleTargetSize / BUBBLE_IMG_SIZE;

    // ุฅูุดุงุก ุงูููุงุนุงุช
    shuffledOptions.forEach((optionText, index) => {
        const bubble = bubbles.create(
            width * (0.2 + index * 0.3), 
            height * 0.2, 
            `bubble${index + 1}`
        ).setScale(bubbleScale);

        bubble.setCircle(BUBBLE_IMG_SIZE / 2);
        bubble.setOffset(0, 0); 
        bubble.setBounce(1);

        // โฌ๏ธ ุฅุถุงูุฉ ุจูุงูุงุช ุงูุณุคุงู ID ุฅูู ุงูููุงุนุฉ โฌ๏ธ
        bubble.setData('questionId', q.id); 

        if (optionText === correctOptionText) {
            bubble.setData('isCorrect', true);
        } else {
            bubble.setData('isCorrect', false);
        }
        
        // ุญุฑูุฉ ุนุดูุงุฆูุฉ ููููุงุนุงุช
        const angle = Phaser.Math.FloatBetween(Math.PI / 4, 3 * Math.PI / 4);
        const speed = Phaser.Math.Between(150, 250);
        bubble.setVelocity(Math.cos(angle) * speed, Math.sin(angle) * speed);
    });
    
    newCorrectIndex = newCorrectIndex; // ูุฐุง ุงููุชุบูุฑ ูู ูุนุฏ ูุณุชุฎุฏูุงู ูุนููุงู ููููู ูุง ูุถุฑ
    canShoot = true; // ูููู ุงูุฅุทูุงู ูุฌุฏุฏุงู
}

/* ====================== 8. ููุทู ุงูุฅุตุงุจุฉ (Hit) ====================== */
function bubbleHit(scene, bubble){
    const isCorrect = bubble.getData('isCorrect');
    const questionId = bubble.getData('questionId'); 
    bubble.destroy();

    if(isCorrect){
        scene.correctSound.play();
        
        // โฌ๏ธ ุชุญุฏูุซ ุงูููุงุท โฌ๏ธ
        score += 10;
        scoreDisplay.textContent = score; 

        // โฌ๏ธ ุงูุชุญูู ูู ุฅุฒุงูุฉ ุงูุณุคุงู ูู ูุงุฆูุฉ ุงูุฃุณุฆูุฉ ุงูุฎุงุทุฆุฉ (ุฅุฐุง ูุงู ููุฑุฑ) โฌ๏ธ
        const wrongIndex = wrongQuestions.findIndex(q => q.id === questionId);
        if (wrongIndex > -1) {
            // ุฅุฒุงูุฉ ุงูุณุคุงู ูู ุงููุฑุงุฌุนุฉ ุจุนุฏ ุงูุฅุฌุงุจุฉ ุนููู ุตุญูุญุงู
            wrongQuestions.splice(wrongIndex, 1);
        }

        scene.time.delayedCall(500, () => {
            // ุฅุฐุง ูู ููู ูุฑุงุฌุน ุณุคุงูุงู ุฎุงุทุฆุงูุ ููุชูู ููุณุคุงู ุงูุชุงูู
            if (wrongIndex === -1 && currentQ < totalQuestions) {
                 currentQ++;
            }
            
            // โฌ๏ธ ุงูุชุญูู ูู ููุงูุฉ ุงููุนุจุฉ โฌ๏ธ
            if (currentQ >= totalQuestions && wrongQuestions.length === 0) {
                 gameOver(scene, true); 
            } else {
                 showQuestion(scene);
            }
        });
    } else {
        scene.wrongSound.play();
        wrongFlash();
        
        // โฌ๏ธ ุชุณุฌูู ุงูุณุคุงู ูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ (ูููุฑุงุฌุนุฉ ูู ุงูููุงูุฉ) โฌ๏ธ
        let currentQuestion;
        if (wrongQuestions.length > 0) {
            currentQuestion = wrongQuestions[0];
        } else if (currentQ < totalQuestions) {
            currentQuestion = QUESTIONS[currentQ];
        } else {
             // ูุง ููุฌุฏ ุณุคุงู ูุชุณุฌููู ูุฎุทุฃ
             return; 
        }

        if (!wrongQuestions.some(q => q.id === currentQuestion.id)) {
             wrongQuestions.push({
                 id: currentQuestion.id,
                 q: currentQuestion.q,
                 a: currentQuestion.a,
                 o: currentQuestion.o
             });
        }
        
        scene.time.delayedCall(1000, () => {
            // ุงูุงุณุชูุฑุงุฑ ูู ุงูุณุคุงู ุงูุญุงูู/ุงููุฑุงุฌุน
            showQuestion(scene); 
        });
    }
}

/* ====================== 9. ูุธุงุฆู ููุงูุฉ ุงููุนุจุฉ ูุงูููุฎุต ====================== */

// โฌ๏ธ ุฏุงูุฉ ุนุฑุถ ููุฎุต ุงููุนุจุฉ (ููุชุจุณุฉ ูู CarRace.html) โฌ๏ธ
function showSummaryBox(finalScore, title, reviewContent) {
    const summaryOverlay = document.getElementById('summaryOverlay');
    const summaryTitle = document.getElementById('summaryTitle');
    const summaryScore = document.getElementById('summaryScore');
    const scrollableReview = document.getElementById('scrollableReview');
    const restartBtn = document.getElementById('restartBtn');

    // 1. ููุก ุงููุญุชูู
    summaryTitle.textContent = title;
    summaryScore.textContent = `ุงูููุงุท ุงููุญุชุณุจุฉ: ${finalScore} / ${totalQuestions * 10}`;

    scrollableReview.innerHTML = reviewContent;

    // 2. ุฑุจุท ุฒุฑ ุงูุฅุนุงุฏุฉ
    restartBtn.onclick = () => {
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุนุงุฏุฉ ุชุดุบูู ุงููุนุจุฉ
        window.location.reload(); 
    };

    // 3. ุฅุธูุงุฑ ูุงูุฐุฉ ุงูููุฎุต (ูุงูุฐุฉ HTML)
    summaryOverlay.style.display = 'flex';
}

// โฌ๏ธ ุฏุงูุฉ ุฅููุงุก ุงููุนุจุฉ (ููุชุจุณุฉ ูู CarRace.html) โฌ๏ธ
function gameOver(scene, completed) {
    if (gameFinished) return;
    gameFinished = true; 

    scene.physics.pause();
    bubbles.clear(true, true);
    document.getElementById('questionHeader').innerHTML = `<h3>ุงูุชูุช ุงููุนุจุฉ!</h3>`;

    const finalScore = score;
    let title = 'ูุนุจุฉ ุฑุงุฆุนุฉ! ๐';
    
    if (finalScore === totalQuestions * 10) {
        title = 'ูุฐูู! ุงูุฅุฌุงุจุฉ ุนูู ุฌููุน ุงูุฃุณุฆูุฉ ุจุดูู ุตุญูุญ! ๐';
    } else if (finalScore < totalQuestions * 10 && finalScore > 0) {
        title = 'ูุชูุฌุฉ ุฌูุฏุฉ! ููููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุชุญุณูููุง! ๐ช';
    } else if (finalScore === 0) {
        title = 'ูุง ุจุฃุณ! ุญุงูู ุงูุชุฑููุฒ ุฃูุซุฑ ูู ุงููุฑุฉ ุงููุงุฏูุฉ. ๐ก';
    }

    // ุชุฌููุฒ ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ
    let reviewContent = '';
    
    if (wrongQuestions.length > 0) {
        wrongQuestions.forEach((q, index) => {
            const correctAnswer = q.o[q.a];
            reviewContent += `
                <p style="font-weight: bold; color: #f72585;">ุงูุณุคุงู ${index + 1} (ุชูุช ุงูุฅุฌุงุจุฉ ุนููู ุฎุทุฃู):</p>
                <p style="margin-right: 15px;">**${q.q}**</p>
                <p style="margin-right: 15px; color: #4cc9f0;">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ${correctAnswer}</p>
                <hr style="border-color: #333; margin: 10px 0;">
            `;
        });
    } else {
         reviewContent = '<p style="font-weight: bold; color: #2ecc71; text-align: center;">๐ ููุฏ ุฃุฌุจุช ุนูู ุฌููุน ุงูุฃุณุฆูุฉ ุจูุฌุงุญ ูู ุงููุญุงููุฉ ุงูุฃุฎูุฑุฉ!</p>';
    }

    // ุนุฑุถ ุดุงุดุฉ ุงูููุฎุต
    showSummaryBox(finalScore, title, reviewContent);
    scene.winSound.play();
}

/* ====================== 10. ููุทู ุดุงุดุฉ ุงูุจุฏุงูุฉ ====================== */
document.getElementById('startButton').onclick = () => {
    document.getElementById('introScreen').classList.add('hidden');
    // ุชุดุบูู ุงููุนุจุฉ ูุจุฏุฃ ุชููุงุฆูุงู ุนูุฏ ุชุญููู ุงููุดูุฏ
    // ููุง ูุฌุจ ุฃู ุชุชุฃูุฏ ุฃู ุงููุนุจุฉ ูุฏ ุชู ุฅุนุฏุงุฏูุง ูุจู ุฅุฒุงูุฉ ุดุงุดุฉ ุงูุจุฏุงูุฉ
    // (ุงูู Phaser.Game(config) ูููู ุจุฐูู)
};

// โฌ๏ธ ุฏุงูุฉ ุฎูุท ุงููุตูููุฉ (ูุฎูุท ุงูุฃุณุฆูุฉ ูู ุงูุจุฏุงูุฉ) โฌ๏ธ
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}
// โฌ๏ธ ุฎูุท ุงูุฃุณุฆูุฉ ุนูุฏ ุจุฏุก ุงูููุฏ โฌ๏ธ
shuffleArray(QUESTIONS);


</script>
</body>
</html>
