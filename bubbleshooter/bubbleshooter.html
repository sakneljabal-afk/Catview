<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯ÙØ¹ ÙˆØ§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

<style>
body{
  margin:0;
  background:#add8e6;
  font-family:Arial;
  touch-action: none; /* Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¨Ø§Ù„Ø³Ø­Ø¨ */
}
header{
  background:#000;
  color:#fff;
  text-align:center;
  padding:0.5em;
  height: 10vh;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
header h3{
  margin:0;
  font-size:clamp(1.2rem, 4vw, 1.8rem);
}
.answers{
  display:flex;
  justify-content:center;
  gap:1em;
  margin-top:.2em;
  font-size:clamp(1rem, 3.5vw, 1.4rem);
}
main{
  display:flex;
  justify-content:center;
  align-items: center;
  height: 90vh; /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
  background: #add8e6;
}
#game-frame{
  width:98vw;
  height: 88vh; /* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
  max-width:600px;
  background:#e9f7ff;
  border:4px solid #333;
  border-radius:12px;
  overflow:hidden;
  position: relative;
}
#game-container{width:100%;height:100%}
#wrongFlash{
  position:fixed;
  inset:0;
  background:rgba(255,0,0,0);
  pointer-events:none;
  transition:.2s;
  z-index: 999;
}
</style>
</head>

<body>

<header id="questionHeader"></header>

<main>
  <section id="game-frame">
    <div id="game-container"></div>
  </section>
</main>

<div id="wrongFlash"></div>

<script>
/* ======================
   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
====================== */
const QUESTIONS = [
 { q:"Ù…Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ø­Ù…Ø±ØŸ", o:["Ø§Ù„Ø²Ù‡Ø±Ø©","Ø§Ù„Ù…Ø±ÙŠØ®","Ø§Ù„Ù…Ø´ØªØ±ÙŠ"], a:1 },
 { q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±Ø¬Ù„ Ø§Ù„Ù‚Ø·ØŸ", o:["2","4","6"], a:1 },
 { q:"Ù†Ø§ØªØ¬ 5 + 5ØŸ", o:["9","10","11"], a:1 },
 { q:"Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", o:["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©","Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©","Ø£Ø³ÙˆØ§Ù†"], a:0 }
];

/* ======================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Phaser
====================== */
const config={
 type:Phaser.AUTO,
 parent:'game-container',
 width:window.innerWidth,  // Ù…Ù„Ø¡ Ø§Ù„Ø¥Ø·Ø§Ø±
 height:window.innerHeight,
 scale:{
   mode:Phaser.Scale.RESIZE,
   autoCenter: Phaser.Scale.CENTER_BOTH
 },
 physics:{
   default:'arcade',
   arcade:{
     gravity:{y:0}, // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø§Ø°Ø¨ÙŠØ© Ù„ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø·ÙÙˆ
     debug: false   // Ø§Ø¬Ø¹Ù„Ù‡Ø§ true Ù„Ø±Ø¤ÙŠØ© Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªØµØ§Ø¯Ù…
   }
 },
 scene:{preload,create,update}
};
const game = new Phaser.Game(config);

/* ======================
   Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
====================== */
let cannon, bubbles, arrow, invisibleWall;
let currentQ=0;
let canShoot=true;
let isAiming=false;
let missedShots=0;

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø­Ø¬Ø§Ù…
let bubbleScaleRatio = 1;
let shotScaleRatio = 1;
let cannonScaleRatio = 1;

/* ======================
   Preload
====================== */
function preload(){
 // Ø§Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ùƒ Ù‡Ù†Ø§. Ù†ÙØªØ±Ø¶ Ø£Ù† Ø­Ø¬Ù… Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø£ØµÙ„ÙŠ 300x300
 this.load.image('cannon','assets/cannon.png');
 this.load.image('shoot','assets/shoot.png');
 this.load.image('bubble1','assets/bubble1.png');
 this.load.image('bubble2','assets/bubble2.png');
 this.load.image('bubble3','assets/bubble3.png');
 this.load.audio('correct','assets/correct.mp3');
 this.load.audio('wrong','assets/wrong.mp3');
}

/* ======================
   Create
====================== */
function create(){
 const width = this.scale.width;
 const height = this.scale.height;

 // === 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ===
 // Ù†Ø±ÙŠØ¯ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ØªØ£Ø®Ø° Ø­ÙˆØ§Ù„ÙŠ 22% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©
 const targetBubbleWidth = width * 0.22; 
 // Ø§Ù„Ù…ØµØ¯Ø± 300 Ø¨ÙƒØ³Ù„ØŒ Ù„Ø°Ø§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ù‡Ùˆ:
 bubbleScaleRatio = targetBubbleWidth / 300;

 // Ø§Ù„Ù‚Ø°ÙŠÙØ© Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø© (Ù…Ø«Ù„Ø§Ù‹ 15% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©)
 const targetShotWidth = width * 0.15;
 shotScaleRatio = targetShotWidth / 300; // Ø¨Ø§ÙØªØ±Ø§Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø°ÙŠÙØ© Ù…Ø±Ø¨Ø¹Ø© Ø£ÙŠØ¶Ø§Ù‹

 // Ø§Ù„Ù…Ø¯ÙØ¹
 cannonScaleRatio = (height * 0.15) / 300; // Ù†Ø³Ø¨Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¯ÙØ¹

 // === 2. Ø§Ù„Ø£ØµÙˆØ§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ ===
 this.correctSound=this.sound.add('correct');
 this.wrongSound=this.sound.add('wrong');
 this.physics.world.setBounds(0,0,width,height);

 // === 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§Ø± ØºÙŠØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ (Ù„Ø­ØµØ± Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) ===
 // Ù†Ø¶Ø¹Ù‡ Ø¹Ù†Ø¯ 55% Ù…Ù† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø©
 invisibleWall = this.add.rectangle(width/2, height * 0.55, width, 20, 0x000000, 0); 
 this.physics.add.existing(invisibleWall, true); // true ØªØ¹Ù†ÙŠ static (Ø«Ø§Ø¨Øª Ù„Ø§ ÙŠØªØ­Ø±Ùƒ)

 // === 4. Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª ===
 cannon=this.add.sprite(width/2, height*0.90, 'cannon')
   .setScale(cannonScaleRatio);

 // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª
 bubbles=this.physics.add.group({
   collideWorldBounds: true,
   bounceX: 1,
   bounceY: 1
 });

 // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµØ§Ø¯Ù… Ø¨ÙŠÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§Ø± ØºÙŠØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ
 this.physics.add.collider(bubbles, invisibleWall);

 // Ø§Ù„Ø³Ù‡Ù…
 arrow=this.add.text(cannon.x, cannon.y - (cannon.displayHeight/1.2), 'â¬†ï¸', {fontSize:'30px'})
   .setOrigin(0.5);

 // === 5. Ø§Ù„ØªØ­ÙƒÙ… ===
 this.input.on('pointermove', p=>{
   // ØªÙ‚ÙŠÙŠØ¯ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø¯ÙØ¹
   cannon.x=Phaser.Math.Clamp(p.x, width*0.1, width*0.9);
   arrow.x=cannon.x;
 });

 this.input.on('pointerdown', ()=>{
   if(!isAiming){isAiming=true;return;}
   if(canShoot) fire(this);
 });

 // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
 showQuestion(this);
}

function update() {
  // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø§Ù† Ø¨Ø³ÙŠØ· Ù„Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ù„Ø¥Ø¶ÙØ§Ø¡ Ø­ÙŠÙˆÙŠØ©
  bubbles.children.iterate((b) => {
    if(b) b.rotation += 0.01;
  });
}

/* ======================
   Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚Ø°ÙŠÙØ©
====================== */
function fire(scene){
 canShoot=false;
 isAiming=false;
 arrow.setVisible(false);

 const shot=scene.physics.add.sprite(
   cannon.x,
   cannon.y - cannon.displayHeight/2,
   'shoot'
 ).setScale(shotScaleRatio); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±

 // Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø°ÙŠÙØ©
 shot.setVelocityY(-scene.scale.height * 0.9); 

 // Ø§Ù„ØªØµØ§Ø¯Ù… Ù…Ø¹ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª
 scene.physics.add.overlap(shot, bubbles, (s,b)=>{
   s.destroy();
   missedShots=0;
   bubbleHit(scene,b);
 });

 shot.setCollideWorldBounds(true);
 shot.body.onWorldBounds=true;

 // Ø§Ù„Ù‚Ø°ÙŠÙØ© ØªØ®Ø·Ø¦ ÙˆØªØµØ·Ø¯Ù… Ø¨Ø§Ù„Ø³Ù‚Ù
 shot.body.world.on('worldbounds', body=>{
   if(body.gameObject===shot){
     shot.destroy();
     missedShots++;
     if(missedShots>=2){ // Ù…Ø­Ø§ÙˆÙ„ØªÙŠÙ† ÙØ§Ø´Ù„ØªÙŠÙ† = Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨
       missedShots=0;
       showQuestion(scene);
     }
   }
 });

 // ØªÙ†Ø¸ÙŠÙ
 scene.time.delayedCall(1500, ()=> { if(shot.active) shot.destroy(); });
 scene.time.delayedCall(800, ()=>{
   canShoot=true;
   arrow.setVisible(true);
 });
}

/* ======================
   Ø¥ØµØ§Ø¨Ø© Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
====================== */
function bubbleHit(scene, bubble){
 const correct = bubble.getData('correct');
 
 // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
 bubble.destroy();

 if(correct){
   scene.correctSound.play();
   // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
   scene.time.delayedCall(500, ()=>{
     currentQ++;
     showQuestion(scene);
   });
 }else{
   scene.wrongSound.play();
   document.getElementById('wrongFlash').style.background='rgba(255,0,0,0.5)';
   setTimeout(()=>document.getElementById('wrongFlash').style.background='rgba(255,0,0,0)', 300);
   
   // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª ÙƒØ¹Ù‚Ø§Ø¨ Ø¨Ø³ÙŠØ·
   scene.time.delayedCall(600, ()=> showQuestion(scene));
 }
}

/* ======================
   Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„ÙÙ‚Ø§Ø¹Ø§Øª
====================== */
function showQuestion(scene){
 const q = QUESTIONS[currentQ];
 if(!q){
   document.getElementById('questionHeader').innerHTML='<h3>ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>';
   bubbles.clear(true,true);
   return;
 }

 document.getElementById('questionHeader').innerHTML= `
   <h3>${q.q}</h3>
   <div class="answers">
     <span>1: ${q.o[0]}</span> | 
     <span>2: ${q.o[1]}</span> | 
     <span>3: ${q.o[2]}</span>
   </div>
 `;

 bubbles.clear(true,true);
 
 const width = scene.scale.width;
 const startPositions = [0.2, 0.5, 0.8]; // Ø£Ù…Ø§ÙƒÙ† Ù…Ø¨Ø¯Ø¦ÙŠØ©

 for(let i=0; i<3; i++){
   // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
   const b = bubbles.create(
     width * startPositions[i],
     scene.scale.height * 0.25, // ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ
     'bubble'+(i+1)
   ).setScale(bubbleScaleRatio); // Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ¨ÙŠØ± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ

   // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
   b.setCircle(140); // Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªØµØ§Ø¯Ù… Ù„Ù„Ø¯Ø§Ø¦Ø±Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© 300 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
   b.setData('correct', i === q.a);
   
   // === Ø­Ø±ÙƒØ© Ø§Ù„Ø·ÙÙˆ ===
   // Ø³Ø±Ø¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙÙŠ X Ùˆ Y Ù„ØªØ¨Ø¯Ùˆ ÙƒØ£Ù†Ù‡Ø§ ØªØ³Ø¨Ø­
   b.setVelocity(
     Phaser.Math.Between(-60, 60), 
     Phaser.Math.Between(-40, 40)
   );
   
   b.setBounce(1); // Ø§Ø±ØªØ¯Ø§Ø¯ ÙƒØ§Ù…Ù„
   b.setCollideWorldBounds(true);
   // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØµØ§Ø¯Ù… Ù…Ø¹ invisibleWall ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ ÙÙŠ create
 }
}
</script>
</body>
</html>
