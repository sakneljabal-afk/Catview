<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุนุจุฉ ุงููุฏูุน ูุงูููุงุนุงุช ุงูุชุนููููุฉ</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    <style>
        /* ๐จ CSS ุงูุชุตููู */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Arial', sans-serif;
            direction: rtl; 
            background-color: #add8e6; 
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ูุฑุจุน ุงูุณุคุงู */
        #questionBox {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; 
            background-color: rgba(0, 0, 0, 0.8); 
            color: white;
            padding: 15px;
            box-sizing: border-box;
            text-align: center;
            /* ุณูุนุฑุถู ุฏุงุฆูุงูุ ููู ุณูุบูุฑ ูุญุชูุงู */
        }

        #questionBox h3 {
            margin: 0;
            font-size: clamp(1.2em, 3vw, 1.5em); 
        }

        /* ููุฏุจุงู ุฎุทุฃ (ุงูููู ุงูุฃุญูุฑ) */
        #wrongFeedback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(255, 0, 0, 0); 
            z-index: 999; 
            pointer-events: none;
            transition: background-color 0.1s; 
        }
        
        /* ูุคุดุฑ ุงูุฎุทุฃ ุงูุจุตุฑู (โ) */
        #errorIndicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em; 
            color: white;
            z-index: 1001; 
            opacity: 0; 
            pointer-events: none;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div id="wrongFeedback"></div>
    <div id="errorIndicator">โ</div>
    <div id="questionBox"></div>
    <div id="game-container"></div>

<script>
    // ๐พ ูุตูููุฉ ุงูุฃุณุฆูุฉ (ุชู ุฅุถุงูุฉ ุญูู "index" ูุคูุช ูุชุญุฏูุฏ ุงูููุงุนุฉ ุงูุตุญูุญุฉ)
    const QUESTIONS = [
        {question:"ูุง ูู ุงููููุจ ุงูุฐู ูุณูู 'ุงููููุจ ุงูุฃุญูุฑ'ุ", options:["ุงูุฒูุฑุฉ","ุงููุฑูุฎ","ุงููุดุชุฑู"], correctAnswer:"ุงููุฑูุฎ"},
        {question:"ูู ุนุฏุฏ ุฃุฑุฌู ุงููุทุทุ", options:["ุงุซููู","ุฃุฑุจุนุฉ","ุณุชุฉ"], correctAnswer:"ุฃุฑุจุนุฉ"},
        {question:"ูุง ูู ุฃูุจุฑ ูุญูุท ูู ุงูุนุงููุ", options:["ุงูุฃุทูุณู","ุงูููุฏู","ุงููุงุฏุฆ"], correctAnswer:"ุงููุงุฏุฆ"},
        {question:"ูุง ูู ุงูุดูู ุงูููุฏุณู ุงูุฐู ูุญุชูู ุนูู ุซูุงุซุฉ ุฃุถูุงุนุ", options:["ุงููุฑุจุน","ุงููุซูุซ","ุงูุฏุงุฆุฑุฉ"], correctAnswer:"ุงููุซูุซ"}
    ];

    // ๐ผ๏ธ ุฅุนุฏุงุฏุงุช ุงููุนุจุฉ
    const config = {
        type: Phaser.AUTO,
        width: 800, // ุญุฌู ุงูุชุฑุงุถู (ุณูุชู ุชุนุฏููู ุจุงูู scale)
        height: 1200, // ุชุตููู ุนููุฏู ููููุงุชู
        parent: 'game-container',
        scale: { 
            mode: Phaser.Scale.FIT, 
            autoCenter: Phaser.Scale.CENTER_BOTH,
            parent: 'game-container',
            // ุงูุฅุนุฏุงุฏุงุช ุงูุชู ุชุฌุนููุง ุฏููุงููููุฉ ููุชูุงููุฉ ูุน ุงูููุงุชู:
            width: 800,
            height: 1200
        },
        physics: { 
            default:'arcade', 
            arcade:{ 
                gravity:{y:0}, 
                debug:false // ุบูุฑูุง ูู true ููุชุตุญูุญ
            } 
        },
        scene: { preload, create, update }
    };

    let game = new Phaser.Game(config);

    // ูุชุบูุฑุงุช ุงููุดูุฏ ุงูุนุงูุฉ
    let cannon, projectileGroup, bubblesGroup;
    let questionBox, wrongFeedbackDiv, errorIndicator;
    let correctSound, wrongSound;
    let currentQuestionIndex = 0;
    let questionToRepeat = null; // ุงูุณุคุงู ุงูุฐู ูุชู ุชูุฑุงุฑู ุนูุฏ ุงูุฎุทุฃ
    let originalQuestionIndexBeforeError = 0; // ูุคุดุฑ ุงูุณุคุงู ุงูุฐู ุฃุฎุทุฃูุง ุนูุฏู ูุฃูู ูุฑุฉ

    const BUBBLE_TYPES = ['bubble1', 'bubble2', 'bubble3'];
    const BUBBLE_SCALE = 0.4; // ูุถูุงู ุงูุญุฌู ุงูููุงุณุจ ุนูู ุงููุงุชู
    let FIRE_DELAY = 300; // ุชุฃุฎูุฑ ุฅุทูุงู ุงููุฐููุฉ ุจุงูููู ุซุงููุฉ
    let lastFired = 0;

    function preload() {
        // โ๏ธ ุชุฃูุฏ ูู ุชููุฑ ูุฐู ุงูุตูุฑ ูู ูุฌูุฏ assets/
        this.load.image('cannon', 'bubbleshooter/assets/cannon.png');
        this.load.image('shoot', 'bubbleshooter/assets/shoot.png');
        this.load.image('bubble1', 'bubbleshooter/assets/bubble1.png');
        this.load.image('bubble2', 'bubbleshooter/assets/bubble2.png');
        this.load.image('bubble3', 'bubbleshooter/assets/bubble3.png');
        // โ๏ธ ุชุฃูุฏ ูู ุชููุฑ ุงูุฃุตูุงุช
        this.load.audio('correct','bubbleshooter/assets/correct.mp3'); 
        this.load.audio('wrong','bubbleshooter/assets/wrong.mp3');
        this.load.audio('fire','bubbleshooter/assets/fire.mp3'); // ุตูุช ุฅุทูุงู ุงููุฏูุน
    }

    function create() {
        const { width, height } = this.scale;
        
        // 1. ุฅุนุฏุงุฏ ุนูุงุตุฑ HTML
        questionBox = document.getElementById('questionBox');
        wrongFeedbackDiv = document.getElementById('wrongFeedback');
        errorIndicator = document.getElementById('errorIndicator');

        // 2. ุฅุนุฏุงุฏ ุงูุฃุตูุงุช
        correctSound = this.sound.add('correct');
        wrongSound = this.sound.add('wrong');
        this.fireSound = this.sound.add('fire');

        // 3. ุฅุนุฏุงุฏ ุงููุฏูุน (Cannon)
        cannon = this.add.sprite(width / 2, height * 0.95, 'cannon').setScale(0.5);
        cannon.setDepth(10);
        
        // 4. ูุฌููุนุงุช ุงูููุฒูุงุก (Physics Groups)
        projectileGroup = this.physics.add.group({
            defaultKey: 'shoot',
            maxSize: 10,
            runChildUpdate: true
        });

        bubblesGroup = this.physics.add.group({
            key: BUBBLE_TYPES,
            immovable: false,
            runChildUpdate: true
        });

        // 5. ุชูุงุนูุงุช ุงูุงุตุทุฏุงู
        this.physics.add.overlap(projectileGroup, bubblesGroup, hitBubble, null, this);

        // 6. ุงูุชุญูู ุจุงูุฅุฏุฎุงู (ุงููุฏูุน ูุชุจุน ุญุฑูุฉ ุงููุคุดุฑ)
        this.input.on('pointermove', pointer => {
            // ุงููุฏูุน ูุชุญุฑู ุฃูููุงู ููุท
            cannon.x = Phaser.Math.Clamp(pointer.x, width * 0.1, width * 0.9);
        });

        // 7. ุฅุทูุงู ุงููุฐููุฉ ุนูุฏ ุงูููุฑ
        this.input.on('pointerdown', pointer => {
            fireProjectile(this);
        });

        // 8. ุจุฏุก ุงููุนุจุฉ
        showQuestion(currentQuestionIndex);
    }

    function update(time, delta) {
        // ุงููุฏูุน ูุฌุจ ุฃู ููุธุฑ ุฅูู ูุคุดุฑ ุงููุฃุฑุฉ (ุงุฎุชูุงุฑูุ ูุถูู ููุณุฉ ุฌูุงููุฉ)
        // const pointer = this.input.activePointer;
        // cannon.rotation = Phaser.Math.Angle.Between(cannon.x, cannon.y, pointer.x, pointer.y) + Math.PI / 2;
    }

    // --- ููุทู ุงููุฏูุน ูุงููุฐุงุฆู ---

    function fireProjectile(scene) {
        if (scene.time.now > lastFired + FIRE_DELAY) {
            this.fireSound.play();
            const projectile = projectileGroup.get(cannon.x, cannon.y - cannon.displayHeight/2);
            
            if (projectile) {
                projectile.setActive(true).setVisible(true).setScale(0.2);
                projectile.body.setCircle(projectile.width/2);
                projectile.body.setMass(1);
                
                // ุฅุทูุงู ุงููุฐููุฉ ููุฃุนูู
                projectile.setVelocityY(-1000); 
                lastFired = scene.time.now;

                // ุฅุฒุงูุฉ ุงููุฐููุฉ ุนูุฏ ุฎุฑูุฌูุง ูู ุงูุดุงุดุฉ
                scene.time.delayedCall(1500, () => {
                    projectile.destroy();
                });
            }
        }
    }

    function hitBubble(projectile, bubble) {
        // ุชููู ุงููุฐููุฉ ูุฅุฒุงูุชูุง
        projectile.destroy();

        // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูููุงุนุฉ (ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ)
        const bubbleData = bubble.getData('data');

        if (!bubbleData) {
            bubble.destroy(); // ููุงุนุฉ ุจุฏูู ุจูุงูุงุช (ููุชูุธูู ููุท)
            return;
        }

        checkAnswer(bubble, bubbleData.answer);
    }

    // --- ููุทู ุงูููุงุนุงุช ูุงูุฃุณุฆูุฉ ---

    // ุฏุงูุฉ ุฅูุดุงุก ุงูููุงุนุงุช
    function createBubbles(scene, questionData) {
        bubblesGroup.clear(true, true); // ุฅุฒุงูุฉ ุฌููุน ุงูููุงุนุงุช ุงููุฏููุฉ

        const { width, height } = scene.scale;
        const options = questionData.options;
        const bubbleRadius = 60 * BUBBLE_SCALE * 800/width; // ุชูุฏูุฑ ูุตู ูุทุฑ ุงูููุงุนุฉ

        // ุญุณุงุจ ุงููุณุงูุงุช ุงููุชุงุญุฉ ูู ุงูุฌุฒุก ุงูุนููู (ูุซูุงู ุงูุซูุซ ุงูุฃูุณุท ูู ุงูุดุงุดุฉ)
        const startY = height * 0.1;
        const endY = height * 0.5;

        // ุฎูุท ุงูุฎูุงุฑุงุช ูุถูุงู ุงูุชูุฒูุน ุงูุนุดูุงุฆู ููุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
        Phaser.Utils.Array.Shuffle(options); 
        
        options.forEach((opt, index) => {
            const bubbleType = BUBBLE_TYPES[index % BUBBLE_TYPES.length];
            
            // ุงุฎุชูุงุฑ ูููุน ุนุดูุงุฆู ูู ุงูุฌุฒุก ุงูุนููู ูู ุงูุดุงุดุฉ
            const x = Phaser.Math.Between(width * 0.1, width * 0.9);
            const y = Phaser.Math.Between(startY, endY);
            
            const bubble = bubblesGroup.create(x, y, bubbleType).setScale(BUBBLE_SCALE);
            bubble.body.setCircle(bubble.width/2); // ูุฌุนู ุงูุงุตุทุฏุงู ุฏุงุฆุฑู

            // ุชุนููู ุจูุงูุงุช ุงูุฅุฌุงุจุฉ ุนูู ุงูููุงุนุฉ
            bubble.setData('data', {
                answer: opt,
                index: index + 1
            });

            // 1. ุฅุถุงูุฉ ุงููุต (ุฑูู ุงูููุงุนุฉ)
            const numberText = scene.add.text(x, y - 25, (index + 1).toString(), {
                fontFamily: 'Arial',
                fontSize: 30,
                color: '#fff',
                stroke: '#000',
                strokeThickness: 5
            }).setOrigin(0.5);

            // 2. ุฅุถุงูุฉ ูุต ุงูุฅุฌุงุจุฉ
            const answerText = scene.add.text(x, y + 25, opt, {
                fontFamily: 'Arial',
                fontSize: 18,
                color: '#000',
                wordWrap: { width: bubble.displayWidth - 20 }
            }).setOrigin(0.5);

            // ุฌุนู ุงููุตูุต ุชุงุจุนุฉ ููููุงุนุฉ
            bubble.setDepth(2);
            numberText.setDepth(3);
            answerText.setDepth(3);
            
            // ุฑุจุท ุชุญุฏูุซ ูููุน ุงููุต ุจุญุฑูุฉ ุงูููุงุนุฉ
            bubble.on('destroy', () => { numberText.destroy(); answerText.destroy(); });
            bubble.on('postupdate', () => { 
                numberText.x = bubble.x; 
                numberText.y = bubble.y - 25;
                answerText.x = bubble.x;
                answerText.y = bubble.y + 25;
            });
            
            // ุญุฑูุฉ ุนุดูุงุฆูุฉ ููููุงุนุฉ (ุจุทูุฆุฉ)
            const speed = 100;
            bubble.setVelocity(
                Phaser.Math.Between(-speed / 2, speed / 2),
                Phaser.Math.Between(-speed / 2, speed / 2)
            );
            
            // ุถุจุท ุงูุงุฑุชุฏุงุฏ (Bounce) ูุงูุงุตุทุฏุงู ุจุญุฏูุฏ ุงูุนุงูู
            bubble.setBounce(1);
            bubble.setCollideWorldBounds(true);
            bubble.body.onWorldBounds = true;

            // ุถุจุท ุญุฏูุฏ ุงูุญุฑูุฉ ูุชุจูู ุงูููุงุนุงุช ูู ุงูุฌุฒุก ุงูุนููู
            bubble.body.setBoundsRectangle(new Phaser.Geom.Rectangle(0, startY, width, endY - startY));

            bubble.body.world.on('worldbounds', (body) => {
                if (body.gameObject === bubble) {
                    // ุนูุณ ุงูุญุฑูุฉ ุนูุฏ ุงูุงุตุทุฏุงู ุจุงูุญุฏูุฏ ุงูุนูููุฉ/ุงูุณูููุฉ/ุงูุฌุงูุจูุฉ
                    bubble.setVelocity(
                        bubble.body.velocity.x * (body.blocked.left || body.blocked.right ? -1 : 1),
                        bubble.body.velocity.y * (body.blocked.up || body.blocked.down ? -1 : 1)
                    );
                }
            });
        });
        
    }

    // ุฏุงูุฉ ุนุฑุถ ุงูุณุคุงู
    function showQuestion(index){
        const isReviewing = questionToRepeat !== null;
        const q = isReviewing ? questionToRepeat : QUESTIONS[index];
        const scene = game.scene.getScene('default');

        if(!q){
            questionBox.innerHTML='<h3>ุฃุญุณูุช! ููุฏ ุฃูููุช ุงููุนุจุฉ ุจูุฌุงุญ!</h3>';
            bubblesGroup.clear(true, true); // ุฅุฒุงูุฉ ุงูููุงุนุงุช
            return;
        }

        // ุชุญุฏูุซ ูุต ุงูุณุคุงู ูู ูุฑุจุน HTML
        questionBox.innerHTML = `<h3>ุงูุณุคุงู ${isReviewing ? "(ูุฑุงุฌุนุฉ)" : index + 1}: ${q.question}</h3>`;

        // ุฅูุดุงุก ุงูููุงุนุงุช ุงูุฌุฏูุฏุฉ ููุฅุฌุงุจุงุช
        createBubbles(scene, q);
    }

    // ุฏุงูุฉ ุงูุชุญูู ูู ุงูุฅุฌุงุจุฉ (ุชูุณุชุฏุนู ุนูุฏ ุงุตุทุฏุงู ุงููุฐููุฉ ุจููุงุนุฉ)
    function checkAnswer(bubble, selectedAnswer){
        const scene = game.scene.getScene('default');
        
        const isReviewing = questionToRepeat !== null;
        // ูุญุฏุฏ ุงูุณุคุงู ุงูุฐู ูุชู ุงูุฅุฌุงุจุฉ ุนููู
        const currentQ = isReviewing ? 
                                questionToRepeat : 
                                QUESTIONS[currentQuestionIndex];

        // ุชุนุทูู ุงููุฏูุน ูุคูุชุงู ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฅุฌุงุจุฉ
        scene.input.enabled = false;

        if(selectedAnswer === currentQ.correctAnswer){
            // โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
            correctSound.play();
            
            // ุชุฃุซูุฑ ุงููุฌุงุฑ ุงูููุงุนุฉ
            bubble.destroy(); 

            scene.time.delayedCall(500, ()=>{
                // ุฅุนุงุฏุฉ ุชูููู ุงูุฅุฏุฎุงู
                scene.input.enabled = true;
                
                if(isReviewing){
                    // ุญุงูุฉ ุงููุฑุงุฌุนุฉ: ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ุนูู ุณุคุงู ุงูุฎุทุฃ ุงูููุฑุฑ
                    
                    // 1. ุงูุชูุฏู ุณุคุงู ูุงุญุฏ ููุท
                    let nextIndex = currentQuestionIndex + 1; 
                    
                    // 2. ุฅุฐุง ูุตููุง ุฅูู ุงูุณุคุงู ุงูุฐู ุฃุฎุทุฃูุง ุนููู ุฃูู ูุฑุฉุ ููุณุญ ุงูุณุคุงู ุงูููุฑุฑ (Mastered)
                    if (nextIndex === originalQuestionIndexBeforeError) {
                        questionToRepeat = null; // ุฅุชูุงู ุงูุณุคุงู
                        // ููุณุชูุฑ ูู ุงูุชูุฏู ููุณุคุงู ุงูุชุงูู ุจุนุฏ ููุทุฉ ุงูุนูุฏุฉ
                        currentQuestionIndex = nextIndex; 
                        showQuestion(currentQuestionIndex);
                    } else if (nextIndex < QUESTIONS.length) {
                        // ูุณุชูุฑ ูู ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ ุญุชู ูุตู ูููุทุฉ ุงูุนูุฏุฉ
                        currentQuestionIndex = nextIndex;
                        showQuestion(currentQuestionIndex);
                    } else {
                        // ุฃููููุง ุงููุฑุงุฌุนุฉ ูุฃููููุง ุงููุนุจุฉ
                        showQuestion(QUESTIONS.length);
                    }
                    
                } else {
                    // ุงูุชูุฏู ุงูุทุจูุนู (ุณุคุงู ุฌุฏูุฏ)
                    let nextIndex = currentQuestionIndex + 1;
                    
                    if(nextIndex < QUESTIONS.length){
                        currentQuestionIndex = nextIndex;
                        showQuestion(currentQuestionIndex);
                    } else { 
                        showQuestion(nextIndex); // ููุงูุฉ ุงููุนุจุฉ 
                    }
                }
            });

        } else {
            // โ ุงูุฅุฌุงุจุฉ ุงูุฎุงุทุฆุฉ
            wrongSound.play();
            
            // ุชุฃุซูุฑ ุงูุฎุทุฃ ุงูุฃุญูุฑ
            wrongFeedbackDiv.style.backgroundColor='rgba(255,0,0,0.5)';
            errorIndicator.style.opacity = 1;

            scene.time.delayedCall(400, ()=>{
                wrongFeedbackDiv.style.backgroundColor='rgba(255,0,0,0)';
                errorIndicator.style.opacity = 0;
            });
            
            // ููุทู ุงูุฅุชูุงู: ุงูุฑุฌูุน ููุณุคุงู ุงูุณุงุจู
            if(currentQuestionIndex > 0){
                
                // 1. ุชุญุฏูุฏ ุงูุณุคุงู ุงูุญุงูู (ุณุคุงู ุงูุฎุทุฃ) ููุชูุฑุงุฑ
                if(!isReviewing) {
                   questionToRepeat = currentQ;
                   // ุชุณุฌูู ูุคุดุฑ ุงูุณุคุงู ุงูุฐู ูุงู ูุฌุจ ุฃู ูุชูุฏู ุฅููู (ููุทุฉ ุงูุนูุฏุฉ)
                   originalQuestionIndexBeforeError = currentQuestionIndex + 1; 
                }

                // 2. ุงูุฑุฌูุน ููุณุคุงู ุงูุณุงุจู
                let prevIndex = currentQuestionIndex - 1;
                currentQuestionIndex = prevIndex;
                
                scene.time.delayedCall(1500, ()=>{
                    // ุฅุนุงุฏุฉ ุชูููู ุงูุฅุฏุฎุงู
                    scene.input.enabled = true;
                    // showQuestion ุณูุนุฑุถ questionToRepeat
                    showQuestion(currentQuestionIndex); 
                });
                
            } else {
                // ุงูุฎุทุฃ ุนูู ุงูุณุคุงู ุงูุฃูู: ุงูุจูุงุก ูู ุงูููุงู ุญุชู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
                scene.time.delayedCall(500, ()=>{
                    scene.input.enabled = true;
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูููุงุนุงุช ูุชุฑุชูุจ ุฌุฏูุฏ (ุงุฎุชูุงุฑู)
                    showQuestion(currentQuestionIndex); 
                });
            }
        }
    }
</script>
</body>

</html>

