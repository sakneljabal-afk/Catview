<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لعبة المدفع والفقاعات التعليمية</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

<style>
body{
  margin:0;
  background:#add8e6;
  font-family:Arial;
}
header{
  background:#000;
  color:#fff;
  text-align:center;
  padding:1em;
}
header h3{
  margin:0;
  font-size:clamp(1.4rem,5vw,2rem);
}
.answers{
  display:flex;
  justify-content:center;
  gap:1.2em;
  margin-top:.5em;
  font-size:clamp(1.1rem,4.5vw,1.5rem);
}
main{
  display:flex;
  justify-content:center;
  padding:1em 0;
}
#game-frame{
  width:95vw;
  max-width:520px;
  aspect-ratio:3/5;
  background:#e9f7ff;
  border:6px solid #333;
  border-radius:16px;
  overflow:hidden;
}
#game-container{width:100%;height:100%}
#wrongFlash{
  position:fixed;
  inset:0;
  background:rgba(255,0,0,0);
  pointer-events:none;
  transition:.2s;
}
</style>
</head>

<body>

<header id="questionHeader"></header>

<main>
  <section id="game-frame">
    <div id="game-container"></div>
  </section>
</main>

<div id="wrongFlash"></div>

<script>
/* ======================
   الأسئلة
====================== */
const QUESTIONS = [
 { q:"ما هو الكوكب الأحمر؟", o:["الزهرة","المريخ","المشتري"], a:1 },
 { q:"كم عدد أرجل القط؟", o:["2","4","6"], a:1 }
];

/* ======================
   Phaser
====================== */
const config={
 type:Phaser.AUTO,
 parent:'game-container',
 width:600,
 height:900,
 scale:{mode:Phaser.Scale.RESIZE},
 physics:{default:'arcade',arcade:{gravity:{y:0}}},
 scene:{preload,create}
};
new Phaser.Game(config);

let cannon,bubbles,arrow;
let currentQ=0;
let canShoot=true;
let isAiming=false;
let missedShots=0;
const cooldown=900;

/* ======================
   preload
====================== */
function preload(){
 this.load.image('cannon','assets/cannon.png');
 this.load.image('shoot','assets/shoot.png');
 this.load.image('bubble1','assets/bubble1.png');
 this.load.image('bubble2','assets/bubble2.png');
 this.load.image('bubble3','assets/bubble3.png');
 this.load.audio('correct','assets/correct.mp3');
 this.load.audio('wrong','assets/wrong.mp3');
}

/* ======================
   create
====================== */
function create(){
 const {width,height}=this.scale;

 this.correctSound=this.sound.add('correct');
 this.wrongSound=this.sound.add('wrong');

 this.physics.world.setBounds(0,0,width,height);

 this.cannonScale = height*0.00016;
 this.bubbleScale = width *0.00012;
 this.shotScale   = width *0.00015; // ✅ أكبر من السابق

 cannon=this.add.sprite(width/2,height*0.92,'cannon')
   .setScale(this.cannonScale);

 bubbles=this.physics.add.group({
   collideWorldBounds:true,
   bounce:1
 });

 arrow=this.add.text(cannon.x,cannon.y-cannon.displayHeight-10,'⬆️',{fontSize:'24px'})
   .setOrigin(0.5);

 this.input.on('pointermove',p=>{
   cannon.x=Phaser.Math.Clamp(p.x,width*0.12,width*0.88);
   arrow.x=cannon.x;
 });

 this.input.on('pointerdown',()=>{
   if(!isAiming){isAiming=true;return;}
   if(canShoot) fire(this);
 });

 showQuestion(this);
}

/* ======================
   إطلاق
====================== */
function fire(scene){
 canShoot=false;
 isAiming=false;
 arrow.setVisible(false);

 const shot=scene.physics.add.sprite(
   cannon.x,
   cannon.y-cannon.displayHeight,
   'shoot'
 ).setScale(scene.shotScale);

 shot.setVelocityY(-scene.scale.height*0.75);

 scene.physics.add.overlap(shot,bubbles,(s,b)=>{
   s.destroy();
   missedShots=0;
   bubbleHit(scene,b);
 });

 shot.setCollideWorldBounds(true);
 shot.body.onWorldBounds=true;

 shot.body.world.on('worldbounds',body=>{
   if(body.gameObject===shot){
     shot.destroy();
     missedShots++;
     if(missedShots>=2){
       missedShots=0;
       showQuestion(scene); // ✅ إعادة الفقاعات بدون عقاب
     }
   }
 });

 scene.time.delayedCall(1200,()=>shot.destroy());
 scene.time.delayedCall(cooldown,()=>{
   canShoot=true;
   arrow.setVisible(true);
 });
}

/* ======================
   إصابة فقاعة
====================== */
function bubbleHit(scene,bubble){
 const correct=bubble.getData('correct');
 bubble.destroy();

 if(correct){
   scene.correctSound.play();
   scene.time.delayedCall(500,()=>{currentQ++;showQuestion(scene);});
 }else{
   scene.wrongSound.play();
   document.getElementById('wrongFlash').style.background='rgba(255,0,0,.4)';
   setTimeout(()=>document.getElementById('wrongFlash').style.background='rgba(255,0,0,0)',250);
   scene.time.delayedCall(700,()=>showQuestion(scene));
 }
}

/* ======================
   عرض السؤال
====================== */
function showQuestion(scene){
 const q=QUESTIONS[currentQ];
 if(!q){
   document.getElementById('questionHeader').innerHTML='<h3>أحسنت ✅</h3>';
   bubbles.clear(true,true);
   return;
 }

 document.getElementById('questionHeader').innerHTML=`
   <h3>${q.q}</h3>
   <div class="answers">
     <span>1️⃣ ${q.o[0]}</span>
     <span>2️⃣ ${q.o[1]}</span>
     <span>3️⃣ ${q.o[2]}</span>
   </div>
 `;

 bubbles.clear(true,true);
 const xs=[0.25,0.5,0.75];

 for(let i=0;i<3;i++){
   const b=bubbles.create(
     scene.scale.width*xs[i],
     scene.scale.height*0.22,
     'bubble'+(i+1)
   ).setScale(scene.bubbleScale);

   b.setData('correct',i===q.a);
   b.setVelocity(
     Phaser.Math.Between(-25,25), // ✅ أبطأ
     Phaser.Math.Between(30,60)
   );
 }
}
</script>
</body>
</html>
