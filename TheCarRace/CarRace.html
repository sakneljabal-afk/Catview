<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ù…ØªØ³Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ø¹Ù„ÙˆÙ… Ø±Ø§Ø¨Ø¹Ø©</title>
<style>
/* CSS Ù…Ø¹Ø¯Ù‘Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„ */
* {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #87CEEB, #E0F6FF);
    font-family: 'Cairo', Tahoma, Arial, sans-serif;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
    width: 100vw;
    height: 100vh;
}

#gameContainer {
    width: 100vw;
    height: 100vh;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#header {
    width: 100%;
    padding: 12px 5px;
    text-align: center;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 16px);
    color: #2b6fb3;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 100;
    flex-shrink: 0;
}

#gameArea {
    flex: 1;
    position: relative;
    overflow: hidden;
    z-index: 1;
    -webkit-overflow-scrolling: touch;
    touch-action: none;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
#sidebar-left, #sidebar-right, #accelerateBtn, #controls {
    z-index: 10;
}

#sidebar-left {
    position: absolute;
    right: 5px;
    top: 10px;
    width: min(150px, 30vw);
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    background: rgba(240, 248, 255, 0.95);
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    backdrop-filter: blur(5px);
    font-size: clamp(11px, 2.5vw, 12px);
}

#sidebar-left h4 {
    text-align: center;
    margin: 0 0 8px 0;
    color: #2b6fb3;
    border-bottom: 2px solid #2b6fb3;
    padding-bottom: 4px;
    font-size: clamp(12px, 3vw, 13px);
}

.answered {
    margin-bottom: 5px;
    padding: 5px;
    background: #d1ffd1;
    border-radius: 5px;
    border-right: 3px solid #4CAF50;
    font-size: clamp(10px, 2.5vw, 11px);
    line-height: 1.3;
    word-break: break-word;
}

#sidebar-right {
    position: absolute;
    left: 5px;
    top: 10px;
    width: min(130px, 28vw);
    background: rgba(255, 240, 245, 0.95);
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    backdrop-filter: blur(5px);
    font-size: clamp(11px, 2.5vw, 12px);
}

#sidebar-right h4 {
    text-align: center;
    margin: 0 0 8px 0;
    color: #2b6fb3;
    border-bottom: 2px solid #2b6fb3;
    padding-bottom: 4px;
    font-size: clamp(12px, 3vw, 13px);
}

.game-info {
    margin: 6px 0;
    padding: 5px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 5px;
    font-weight: bold;
    text-align: center;
    font-size: clamp(10px, 2.5vw, 11px);
}

#speedMeter {
    height: 15px;
    background: #ddd;
    border-radius: 8px;
    margin: 8px 0;
    overflow: hidden;
    border: 1px solid #aaa;
}

#speedFill {
    height: 100%;
    width: 50%;
    background: linear-gradient(to right, #4CAF50, #FFC107, #FF5722);
    border-radius: 8px;
    transition: width 0.5s;
}

#questionBox {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.4);
    width: 90%;
    max-width: 400px;
    display: none;
    z-index: 1000;
    border: 3px solid #2b6fb3;
}

#questionBox h3 {
    font-size: clamp(16px, 4vw, 20px);
    margin-bottom: 15px;
    color: #2b6fb3;
    line-height: 1.5;
    text-align: center;
}

.choice {
    background: #f0f0f0;
    padding: 15px 10px;
    margin: 10px 0;
    border-radius: 8px;
    cursor: pointer;
    font-size: clamp(14px, 3.5vw, 18px);
    transition: all 0.2s;
    border: 2px solid transparent;
    text-align: center;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}

.choice:hover, .choice:active {
    background: #d0d0d0;
    transform: translateX(-3px);
    border-color: #2b6fb3;
}

.choice.correct {
    background: #d1ffd1;
    border-color: #4CAF50;
}

.choice.wrong {
    background: #ffd1d1;
    border-color: #ff5722;
}

#winScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 200, 0, 0.95);
    color: white;
    font-size: clamp(24px, 6vw, 28px);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    display: none;
    z-index: 1001;
    text-align: center;
    padding: 20px;
}

#winScreen button {
    margin-top: 20px;
    padding: 15px 30px;
    font-size: clamp(16px, 4vw, 18px);
    background: white;
    color: #2b6fb3;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    min-height: 50px;
    min-width: 150px;
    touch-action: manipulation;
}

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø¬ÙˆØ§Ù„ */
#controls {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    z-index: 10;
}

.control-btn {
    width: min(80px, 20vw);
    height: min(80px, 20vw);
    background: rgba(43, 111, 179, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(24px, 6vw, 28px);
    color: white;
    cursor: pointer;
    user-select: none;
    border: 4px solid white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: all 0.1s;
    touch-action: manipulation;
}

.control-btn:active {
    transform: scale(0.95);
    background: rgba(43, 111, 179, 1);
}

#accelerateBtn {
    position: absolute;
    bottom: 120px;
    left: 20px;
    width: min(90px, 22vw);
    height: min(90px, 22vw);
    background: rgba(255, 87, 34, 0.95);
    font-size: clamp(28px, 7vw, 34px);
    z-index: 10;
}

@media only screen and (max-width: 768px) {
    #sidebar-left, #sidebar-right {
        width: min(130px, 35vw);
        font-size: clamp(10px, 2.5vw, 11px);
        top: 10px;
    }
    
    #sidebar-left {
        right: 5px;
    }
    
    #sidebar-right {
        left: 5px;
    }
    
    .game-info {
        font-size: clamp(9px, 2.2vw, 10px);
        padding: 4px;
    }
    
    #controls {
        bottom: 15px;
        gap: 15px;
    }
    
    .control-btn {
        width: min(75px, 18vw);
        height: min(75px, 18vw);
        font-size: clamp(22px, 5.5vw, 26px);
        border-width: 3px;
    }
    
    #accelerateBtn {
        width: min(85px, 20vw);
        height: min(85px, 20vw);
        font-size: clamp(26px, 6.5vw, 32px);
        bottom: 100px;
        left: 15px;
    }
    
    #questionBox {
        padding: 15px;
    }
}

/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
#startScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, #87CEEB, #2b6fb3);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1002;
    text-align: center;
    padding: 20px;
    overflow: auto;
}

#startScreen h1 {
    font-size: clamp(28px, 8vw, 36px);
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

#startScreen p {
    font-size: clamp(16px, 4vw, 18px);
    margin-bottom: 30px;
    max-width: 600px;
    line-height: 1.6;
}

#startScreen button {
    padding: 15px 40px;
    font-size: clamp(18px, 4.5vw, 20px);
    background: white;
    color: #2b6fb3;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    min-height: 50px;
    min-width: 180px;
    touch-action: manipulation;
}

.hidden {
    display: none !important;
}

/* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ ÙÙŠ iOS */
.double-tap-zoom-prevention {
    touch-action: manipulation;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
</head>
<body class="double-tap-zoom-prevention">
<div id="startScreen">
    <h1>ğŸš— Ù…ØªØ³Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© ğŸ§ </h1>
    <p>Ø§Ø®ØªØ± Ø³Ø±Ø¹ØªÙƒ ÙˆØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ±ØªÙØ¹ Ø¯Ø±Ø¬ØªÙƒ!<br>
    Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± ğŸš€ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø£Ùˆ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³Ø§ÙØ©)<br>
    Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ø¶Ø¨Ø· ØªÙˆØ§Ø²Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©<br>
    ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªØ²ÙŠØ¯ Ø³Ø±Ø¹ØªÙƒ!<br>
    <strong>Ø§Ù„Ù…Ø§Ø¯Ø©: Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</strong></p>
    <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
</div>

<div id="gameContainer" class="hidden">
    <div id="header">
        Ù…ØªØ³Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
    </div>
    
    <div id="gameArea">
        <div id="sidebar-left">
            <h4>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</h4>
            <div id="answeredList"></div>
        </div>
        
        <div id="sidebar-right">
            <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h4>
            <div class="game-info">Ø§Ù„Ø³Ø±Ø¹Ø©: <span id="currentSpeed">2</span></div>
            <div class="game-info">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score">0</span></div>
            <div class="game-info">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="questionsRemaining">0</span></div>
            <div id="speedMeter">
                <div id="speedFill"></div>
            </div>
        </div>
        
        <div id="accelerateBtn" class="control-btn">ğŸš€</div>
        
        <div id="controls">
            <div class="control-btn" id="leftBtn">â†</div>
            <div class="control-btn" id="rightBtn">â†’</div>
        </div>
    </div>
</div>

<div id="questionBox">
    <h3 id="qText"></h3>
    <div id="choices"></div>
</div>

<div id="winScreen" class="hidden">
    ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©! ğŸ‰
    <div style="font-size: clamp(18px, 4.5vw, 20px); margin-top: 20px;">Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="finalScore">0</span></div>
    <button onclick="restartGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
</div>

<script>
// ********** Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Phaser) **********
const allQuestions = [
    {
        "q": "ØªØ¹ÙŠØ´ Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø±ÙˆÙ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ù…Ø§Ù„Ø­Ø©ØŒ ÙˆÙ„Ù‡Ø°Ø§ ØªÙ…ØªÙ„Ùƒ ØªÙƒÙŠÙØ§Ù‹ ØªØ±ÙƒÙŠØ¨ÙŠØ§Ù‹ Ù‡Ùˆ:",
        "c": [
            "Ø£ÙˆØ±Ø§Ù‚ Ø¹Ø±ÙŠØ¶Ø© ØªØ·ÙÙˆ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø¡",
            "Ø¬Ø°ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¶Ø¹ÙŠÙØ©",
            "Ø¬Ø°ÙˆØ± Ø·ÙˆÙŠÙ„Ø© ÙˆÙ‚ÙˆÙŠØ© Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù…ÙˆØ§Ø¬"
        ],
        "a": 2
    },
    {
        "q": "Ù…Ø§ Ù‡ÙŠ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø°ÙˆØ± Ø§Ù„Ø·ÙˆÙŠÙ„Ø© ÙˆØ§Ù„Ù‚ÙˆÙŠØ© Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø±ÙˆÙØŸ",
        "c": [
            "ØªØ®Ø²ÙŠÙ† ÙƒÙ…ÙŠØ§Øª ÙƒØ¨ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø§Ø¡",
            "Ø§Ù…ØªØµØ§Øµ Ø§Ù„Ø¶ÙˆØ¡ Ù…Ù† Ø³Ø·Ø­ Ø§Ù„Ù…Ø§Ø¡",
            "Ø§Ù„ØµÙ…ÙˆØ¯ Ø£Ù…Ø§Ù… Ø§Ù„Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©"
        ],
        "a": 2
    },
    {
        "q": "Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙŠ ÙŠÙ†Ù…Ùˆ ÙÙŠÙ‡Ø§ Ù†Ø¨Ø§Øª Ø²Ù†Ø¨Ù‚ Ø§Ù„Ù…Ø§Ø¡ (Ø§Ù„Ù„ÙˆØªØ³) Ù‡ÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ù‚Ø¹Ø§ØªØŒ ÙˆØªØªÙ…ÙŠØ² Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ù€:",
        "c": [
            "Ù…ÙŠØ§Ù‡ Ù…Ø§Ù„Ø­Ø© ÙˆØ£Ù…ÙˆØ§Ø¬ Ù‚ÙˆÙŠØ©",
            "ØªØ±Ø¨Ø© Ø¬Ø§ÙØ© ÙˆØ¯Ø±Ø¬Ø§Øª Ø­Ø±Ø§Ø±Ø© Ù…Ø±ØªÙØ¹Ø©",
            "Ù…ÙŠØ§Ù‡ Ø±Ø§ÙƒØ¯Ø© ÙˆÙƒÙ…ÙŠØ§Øª ÙƒØ¨ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ø·ÙŠÙ†"
        ],
        "a": 2
    },
    {
        "q": "ÙŠÙ…ØªÙ„Ùƒ Ù†Ø¨Ø§Øª Ø²Ù†Ø¨Ù‚ Ø§Ù„Ù…Ø§Ø¡ Ø£ÙˆØ±Ø§Ù‚Ø§Ù‹ Ø¹Ø±ÙŠØ¶Ø© ØªØ·ÙÙˆ Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…Ø§Ø¡ØŒ ÙˆÙ‡Ø°Ø§ Ø§Ù„ØªÙƒÙŠÙ Ø§Ù„ØªØ±ÙƒÙŠØ¨ÙŠ ÙŠØ³Ø§Ø¹Ø¯Ù‡ Ø¹Ù„Ù‰:",
        "c": [
            "Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ø¦ÙŠØ©",
            "ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø²Ø§Ø¦Ø¯",
            "Ø§Ù…ØªØµØ§Øµ Ù‚Ø¯Ø± ÙƒØ¨ÙŠØ± Ù…Ù† Ø¶ÙˆØ¡ Ø§Ù„Ø´Ù…Ø³"
        ],
        "a": 2
    },
    {
        "q": "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙŠ ØªØªÙƒÙŠÙ Ø´Ø¬Ø±Ø© Ø§Ù„ØµÙ†ÙˆØ¨Ø± Ù„Ù„Ø¹ÙŠØ´ ÙÙŠÙ‡Ø§ØŸ",
        "c": [
            "Ø§Ù„Ù…Ø³ØªÙ†Ù‚Ø¹Ø§Øª Ø§Ù„Ù…Ø§Ø¦ÙŠØ©",
            "Ø§Ù„ØµØ­Ø§Ø±ÙŠ Ø§Ù„Ø¬Ø§ÙØ©",
            "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø«Ù„Ø¬ÙŠØ© Ø´Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¨Ø±ÙˆØ¯Ø©"
        ],
        "a": 2
    }
];

// ********** Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© **********
let game; // ÙƒØ§Ø¦Ù† Ù„Ø¹Ø¨Ø© Phaser
let sceneRef; // Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
let keys = {}; // Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
let isAccelerating = false; // Ù‡Ù„ Ø²Ø± Ø§Ù„ØªØ³Ø±ÙŠØ¹ Ù…Ø¶ØºÙˆØ·ØŸ

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¯ÙˆØ§Ù„ Ø§Ù„Ù€ UI
let baseSpeed = 2; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
let score = 0;
let currentQuestions = [...allQuestions];
let answeredQuestions = new Set();
let currentQuestionBox = null;
let gamePaused = false;


// ********** ÙØ¦Ø© Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ **********
class MainScene extends Phaser.Scene {
    constructor() {
        super({ key: 'MainScene' });
        // ** Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø´Ù‡Ø¯ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©) **
        this.car = null;
        this.terrainGroup = null; // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø¬Ø³Ø§Ù… Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„Ù„ØªØ¶Ø§Ø±ÙŠØ³
        this.questionBoxes = null; // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø¬Ø³Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        this.terrainHeight = 0; // Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        this.lastTerrainX = 0; // Ø¢Ø®Ø± Ø¥Ø­Ø¯Ø§Ø«ÙŠ X ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡
        this.scrollVelocity = 0; // Ø³Ø±Ø¹Ø© ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù„Ù… (Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„/Ø«Ø§Ù†ÙŠØ©)
        this.isCarOnGround = false;
        
        // Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (Ø¨Ø¯Ø§Ø¦Ù„ Ù„Ø±Ø³ÙˆÙ…Ø§Øª SVG)
        this.carAssetName = 'car'; 
        this.boxAssetName = 'box';
        this.repeatBoxAssetName = 'repeatBox';
    }

    preload() {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆÙ„ (Assets)
        this.load.image(this.carAssetName, 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCA2MCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjMwIiByeD0iNSIgZmlsbD0iI0ZGMDU3MjIiLz4KPHJlY3QgeD0iNSIgeT0iNSIgd2lkdGg9IjE1IiBoZWlnaHQ9IjgiIGZpbGw9IiMzMzMzMzMiLz4KPHJlY3QgeD0iMjUiIHk9IjUiIHdpZHRoPSIxNSIgaGVpZ2h0PSI4IiBmaWxsPSIjMzMzMzMzIi8+CjxjaXJjbGUgY3g9IjEwIiBjeT0iMjUiIHI9IjYiIGZpbGw9IiMzMzMzMzMiLz4KPGNpcmNsZSBjeD0iNTAiIGN5PSIyNSIgcj0iNiIgZmlsbD0iIzMzMzMzMyIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjI1IiByPSIzIiBmaWxsPSIjNjY2NjY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMjUiIHI9IjMiIGZpbGw9IiM2NjY2NjYiLz4KPC9zdmc+');
        this.load.image(this.boxAssetName, 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiByeD0iNSIgZmlsbD0iI0ZGQzEwNyIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIj4/PC90ZXh0Pgo8L3N2Zz4=');
        this.load.image(this.repeatBoxAssetName, 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCAzNSAzNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM1IiBoZWlnaHQ9IjM1IiByeD0iNiIgZmlsbD0iI0ZGQzEwNyIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMjAiIGZvbnQtd2VpZ2h0PSJib2xkIj4/PC90ZXh0Pgo8L3N2Zz4=');
        this.load.image('ground', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMTAiIHZpZXdCb3g9IjAgMCAyMCAxMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjODZDRjRGIi8+Cjwvc3ZnPg==');
    }

    create() {
        sceneRef = this; // ØªØ¹ÙŠÙŠÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„Ù€ UI Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©

        // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©
        this.physics.world.gravity.y = 800;
        this.physics.world.bounds.setTo(0, 0, 100000, this.game.config.height);
        this.terrainGroup = this.physics.add.staticGroup();
        this.questionBoxes = this.physics.add.group();

        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† ÙÙŠØ²ÙŠØ§Ø¡)
        this.createSky();

        // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©
        this.terrainHeight = this.game.config.height * 0.7;
        this.lastTerrainX = -20;
        this.generateInitialTerrain(this.game.config.width * 2); 
        this.createCar();
        
        // 4. Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        this.createQuestionBoxes(currentQuestions);

        // 5. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù…Ø§Øª
        this.physics.add.collider(this.car, this.terrainGroup, this.onGroundCollide, null, this);
        this.physics.add.overlap(this.car, this.questionBoxes, this.handleQuestionBoxOverlap, null, this);

        // 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        this.cameras.main.startFollow(this.car, true, 0.05, 0.05, -this.game.config.width * 0.3);

        // 7. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ­ÙƒÙ…
        this.cursors = this.input.keyboard.createCursorKeys();

        // 8. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„Ù…Ø³ Ù„Ù€ Phaser Ù†ÙØ³Ù‡
        this.input.addPointer(2); // ÙŠØ¯Ø¹Ù… Ù„Ù…Ø³ØªÙŠÙ† Ù…ØªØ²Ø§Ù…Ù†ØªÙŠÙ†

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updateUI();
    }
    
    createSky() {
        // Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
        const sky = this.add.graphics();
        sky.fillGradientStyle(0x87CEEB, 0x87CEEB, 0xE0F6FF, 0xE0F6FF, 1);
        sky.fillRect(0, 0, this.game.config.width, this.game.config.height);
    }
    
    // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ Ø¨Ø´ÙƒÙ„ ØªØ¯Ø±ÙŠØ¬ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Static Bodies
    generateInitialTerrain(length) {
        let x = this.lastTerrainX + 50; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        let y = this.terrainHeight;
        
        for (; x < length; x += 80) { // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
            y += (Math.random() - 0.5) * 25;
            y = Phaser.Math.Clamp(y, this.game.config.height * 0.6, this.game.config.height * 0.85);
            
            const segment = this.terrainGroup.create(x, y, 'ground');
            segment.setOrigin(0, 0.5);
            segment.body.checkCollision.down = false;
            segment.body.setSize(30, 30);
            segment.refreshBody();
            this.lastTerrainX = x;
            this.terrainHeight = y;
        }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ (ØªÙØ³ØªØ¯Ø¹Ù‰ ÙÙŠ Ø¯Ø§Ù„Ø© update)
    generateMoreTerrain(xOffset) {
        let x = this.lastTerrainX + 80;
        let y = this.terrainHeight;
        
        // ØªÙˆÙ„ÙŠØ¯ ØªØ¶Ø§Ø±ÙŠØ³ Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ 800 Ø¨ÙƒØ³Ù„ Ø®Ø§Ø±Ø¬ Ù…Ø¬Ø§Ù„ Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 1000)
        while (x < xOffset + this.game.config.width + 800) {
            y += (Math.random() - 0.5) * 25;
            y = Phaser.Math.Clamp(y, this.game.config.height * 0.6, this.game.config.height * 0.85);
            
            const segment = this.terrainGroup.create(x, y, 'ground');
            segment.setOrigin(0, 0.5);
            segment.body.checkCollision.down = false;
            segment.body.setSize(30, 30);
            segment.refreshBody();
            
            this.lastTerrainX = x;
            this.terrainHeight = y;
            x += 80; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
    createCar() {
        const initialY = this.terrainHeight - 50;
        this.car = this.physics.add.sprite(this.game.config.width * 0.15, initialY, this.carAssetName);
        this.car.setOrigin(0.5, 0.5);
        this.car.setScale(0.8);
        this.car.setCollideWorldBounds(false);
        this.car.setDragX(200);
        this.car.setAngularDrag(50);
        this.car.setMaxVelocity(400);
        this.car.setDamping(true);
        this.car.setDrag(0.98);
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… (Ù„Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©)
    onGroundCollide(carObj, groundObj) {
        this.isCarOnGround = true;
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø³Ø¤Ø§Ù„
    handleQuestionBoxOverlap(carObj, boxObj) {
        if (!boxObj.getData('answered') && !gamePaused) {
            currentQuestionBox = boxObj;
            showQuestion(boxObj.getData('question'));
            this.scene.pause();
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø³Ø¤Ø§Ù„ Ù…ÙƒØ±Ø± (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ù‡Ø¯)
    createRepeatQuestionBox(question) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø¨Ø¹Ø¯ Ø¨Ù€ 1500 Ø¨ÙƒØ³Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        const repeatX = this.car.x + 1500;
        const repeatY = this.game.config.height * 0.7 - 30;
        
        const repeatBox = this.questionBoxes.create(repeatX, repeatY, this.repeatBoxAssetName);
        repeatBox.setData('question', question);
        repeatBox.setData('answered', false);
        repeatBox.setData('isRepeat', true);
        repeatBox.setImmovable(true);
        repeatBox.setScale(0.9);
        repeatBox.setTint(0xFF5722);
        repeatBox.body.setAllowGravity(false);
        
        // Ø±Ø¨Ø· Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø£Ù‚Ø±Ø¨ ØªØ¶Ø§Ø±ÙŠØ³ Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
        this.correctBoxVerticalPosition(repeatBox);
    }
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (ØªÙØ³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡)
    correctBoxVerticalPosition(box) {
        let nearestTerrainY = this.game.config.height * 0.8;
        
        this.terrainGroup.getChildren().forEach(segment => {
            if (Phaser.Math.Distance.Between(box.x, 0, segment.x, 0) < 50) {
                if (segment.y < nearestTerrainY) {
                    nearestTerrainY = segment.y;
                }
            }
        });
        box.y = nearestTerrainY - 30;
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©)
    createQuestionBoxes(questions) {
        const spacing = 700; 
        questions.forEach((question, index) => {
            const boxX = this.game.config.width + index * spacing + 500;
            const boxY = this.game.config.height * 0.7 - 30;
            
            const box = this.questionBoxes.create(boxX, boxY, this.boxAssetName);
            box.setData('question', question);
            box.setData('answered', false);
            box.setData('isRepeat', false);
            box.setImmovable(true);
            box.setScale(0.8);
            box.body.setAllowGravity(false);
            
            // ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙÙˆØ±Ø§Ù‹
            this.correctBoxVerticalPosition(box);
        });
    }

    update() {
        if (gamePaused) return;

        // ** 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø© **
        const carBody = this.car.body;
        const maxSpeed = baseSpeed * 100;
        
        // Ø§Ù„ØªØ³Ø§Ø±Ø¹ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ
        if (isAccelerating) {
            carBody.setAccelerationX(maxSpeed * 3);
        } else {
            carBody.setAccelerationX(0);
        }
        
        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙŠÙ„ (Ø§Ù„ØªÙˆØ§Ø²Ù†) - Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯ÙˆØ±Ø§Ù†ÙŠ (Angular)
        if (keys['ArrowLeft']) {
            carBody.setAngularVelocity(-150);
        } else if (keys['ArrowRight']) {
            carBody.setAngularVelocity(150);
        } else {
            // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†ÙŠØ© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
            carBody.setAngularVelocity(0);
            carBody.setAngle(Phaser.Math.Linear(this.car.angle, 0, 0.05));
        }

        // ** 2. Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ **
        const cameraScrollX = this.cameras.main.scrollX;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        this.terrainGroup.getChildren().forEach(segment => {
            if (segment.x + 30 < cameraScrollX) {
                segment.destroy();
            }
        });

        // ØªÙˆÙ„ÙŠØ¯ ØªØ¶Ø§Ø±ÙŠØ³ Ø¬Ø¯ÙŠØ¯Ø© (Ø®Ø§Ø±Ø¬ Ù…Ø¬Ø§Ù„ Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
        this.generateMoreTerrain(cameraScrollX);
        
        // Ø¥Ø²Ø§Ù„Ø© ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        this.questionBoxes.getChildren().forEach(box => {
            if (box.x + box.width < cameraScrollX) {
                 if (box.getData('answered')) {
                     box.destroy();
                 }
            }
        });

        // ** 3. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… **
        updateUI();
    }

    // Ø¯Ø§Ù„Ø© ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„ÙÙƒ Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ù…Ø¤Ù‚Øª
    resumeGame() {
        gamePaused = false;
        this.scene.resume();
    }
}


// ********** Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… (ØªØ¸Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø±Ø¨Ø· Ø§Ù„Ù€ HTML) **********
function setupControls() {
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const accelerateBtn = document.getElementById('accelerateBtn');

    const inputEvents = [
        { elem: leftBtn, key: 'ArrowLeft' },
        { elem: rightBtn, key: 'ArrowRight' },
        { elem: accelerateBtn, key: 'Space', isAccel: true }
    ];

    inputEvents.forEach(({ elem, key, isAccel }) => {
        const updateState = (state) => {
            if (isAccel) {
                isAccelerating = state;
            } else {
                keys[key] = state;
            }
        };

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… pointer events (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        elem.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            updateState(true);
            elem.style.transform = 'scale(0.95)';
        });
        
        elem.addEventListener('pointerup', (e) => {
            e.preventDefault();
            updateState(false);
            elem.style.transform = 'scale(1)';
        });
        
        elem.addEventListener('pointerleave', (e) => {
            e.preventDefault();
            updateState(false);
            elem.style.transform = 'scale(1)';
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ù„Ù…Ø³ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø³Ù„Ø¨ÙŠ
        elem.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // Ø¥Ø¶Ø§ÙØ© touch events Ù…Ø¹ passive: false Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        elem.addEventListener('touchstart', (e) => {
            e.preventDefault();
            updateState(true);
            elem.style.transform = 'scale(0.95)';
        }, { passive: false });

        elem.addEventListener('touchend', (e) => {
            e.preventDefault();
            updateState(false);
            elem.style.transform = 'scale(1)';
        }, { passive: false });

        elem.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            updateState(false);
            elem.style.transform = 'scale(1)';
        }, { passive: false });
    });

    // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
            keys[e.key] = true;
            e.preventDefault();
        }
        if (e.key === ' ') {
            isAccelerating = true;
            e.preventDefault();
        }
    });

    window.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
            keys[e.key] = false;
            e.preventDefault();
        }
        if (e.key === ' ') {
            isAccelerating = false;
            e.preventDefault();
        }
    });
}

// ********** Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ùˆ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© **********

function showQuestion(question) {
    gamePaused = true;
    
    const qb = document.getElementById("questionBox");
    document.getElementById("qText").textContent = question.q;
    
    const choicesDiv = document.getElementById("choices");
    choicesDiv.innerHTML = "";
    
    const choices = [...question.c];
    const shuffled = [];
    while (choices.length) {
        const idx = Math.floor(Math.random() * choices.length);
        shuffled.push(choices.splice(idx, 1)[0]);
    }
    
    shuffled.forEach((choice, index) => {
        const originalIndex = question.c.indexOf(choice);
        const choiceDiv = document.createElement("div");
        choiceDiv.className = "choice";
        choiceDiv.textContent = choice;
        choiceDiv.onclick = () => handleAnswer(originalIndex, question, choiceDiv); 
        choicesDiv.appendChild(choiceDiv);
    });
    
    qb.style.display = "block";
}

function handleAnswer(selectedIndex, question, choiceElement) {
    const isCorrect = selectedIndex === question.a;
    
    // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    document.getElementById("choices").querySelectorAll('.choice').forEach(div => div.onclick = null); 
    
    if (isCorrect) {
        choiceElement.classList.add('correct');
        
        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©
        baseSpeed = Math.min(4.5, baseSpeed + 0.3);
        score += 10;
        
        answeredQuestions.add(question.q);
        addToAnsweredList(question);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const index = currentQuestions.findIndex(q => q.q === question.q);
        if (index > -1) {
             currentQuestions.splice(index, 1);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙÙŠ Phaser
        if (currentQuestionBox && sceneRef) {
            currentQuestionBox.setData('answered', true);
            currentQuestionBox.setTint(0x4CAF50);
        }
        
        setTimeout(() => {
            document.getElementById("questionBox").style.display = "none";
            
            if (currentQuestions.length === 0) {
                endGame();
            } else if (sceneRef && sceneRef.scene) {
                sceneRef.scene.resume();
                gamePaused = false;
            }
            
            updateUI();
        }, 1000);
        
    } else {
        choiceElement.classList.add('wrong');
        
        // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø©
        baseSpeed = Math.max(1.5, baseSpeed * 0.7);
        
        // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø³Ø¤Ø§Ù„ Ù…ÙƒØ±Ø±
        if (sceneRef) {
            sceneRef.createRepeatQuestionBox(question);
        }
        
        setTimeout(() => {
            document.getElementById("questionBox").style.display = "none";
            
            if (sceneRef && sceneRef.scene) {
                sceneRef.scene.resume();
                gamePaused = false;
            }
            updateUI();
        }, 1500);
    }
}

function addToAnsweredList(question) {
    const answeredList = document.getElementById("answeredList");
    const div = document.createElement("div");
    div.className = "answered";
    div.textContent = question.q;
    answeredList.appendChild(div);
    answeredList.scrollTop = answeredList.scrollHeight;
}

function updateUI() {
    document.getElementById("currentSpeed").textContent = baseSpeed.toFixed(1);
    document.getElementById("score").textContent = score;
    document.getElementById("questionsRemaining").textContent = currentQuestions.length;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ 4.5 ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
    const speedPercent = (baseSpeed / 4.5) * 100;
    document.getElementById("speedFill").style.width = `${speedPercent}%`;
}

function endGame() {
    gamePaused = true;
    document.getElementById("finalScore").textContent = score;
    document.getElementById("winScreen").classList.remove("hidden");
    if (sceneRef && sceneRef.scene) {
        sceneRef.scene.pause();
    }
}

// ********** Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© **********
function startGame() {
    document.getElementById("startScreen").classList.add("hidden");
    document.getElementById("gameContainer").classList.remove("hidden");
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    baseSpeed = 2;
    score = 0;
    currentQuestions = [...allQuestions];
    answeredQuestions.clear();
    gamePaused = false;
    isAccelerating = false;
    keys = {};
    
    document.getElementById("answeredList").innerHTML = "";
    document.getElementById("winScreen").classList.add("hidden");
    document.getElementById("questionBox").style.display = "none";
    
    setupControls();
    
    if (!game) {
        const headerHeight = document.getElementById('header').offsetHeight || 50;
        const gameAreaHeight = window.innerHeight - headerHeight;
        
        const config = {
            type: Phaser.CANVAS,
            parent: 'gameArea',
            width: window.innerWidth,
            height: gameAreaHeight,
            backgroundColor: '#87CEEB',
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: '100%',
                height: '100%'
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 800 },
                    debug: false
                }
            },
            input: {
                activePointers: 3,
                touch: {
                    capture: true
                }
            },
            scene: MainScene,
            fps: {
                target: 60,
                forceSetTimeOut: true
            }
        };
        
        game = new Phaser.Game(config);
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø´Ù‡Ø¯
        game.scene.stop('MainScene'); 
        game.scene.start('MainScene');
    }
    
    updateUI();
}

function restartGame() {
    document.getElementById("winScreen").classList.add("hidden");
    startGame();
}

// ********** ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© **********
window.addEventListener('resize', () => {
    if (game) {
        const headerHeight = document.getElementById('header').offsetHeight || 50;
        const gameAreaHeight = window.innerHeight - headerHeight;
        
        game.scale.resize(window.innerWidth, gameAreaHeight);
        
        if (sceneRef && sceneRef.cameras) {
            sceneRef.cameras.main.setViewport(0, 0, window.innerWidth, gameAreaHeight);
        }
    }
});

// ********** ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ **********
window.addEventListener('load', function() {
    // Ø¶Ø¨Ø· Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ù„Ø¬ÙˆØ§Ù„
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    
    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¹Ù„Ù‰ iOS
    document.addEventListener('touchmove', function(event) {
        if (event.scale !== 1) {
            event.preventDefault();
        }
    }, { passive: false });
    
    // Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    document.body.classList.add('double-tap-zoom-prevention');
});

// Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
window.addEventListener('orientationchange', function() {
    setTimeout(function() {
        if (game) {
            const headerHeight = document.getElementById('header').offsetHeight || 50;
            const gameAreaHeight = window.innerHeight - headerHeight;
            game.scale.resize(window.innerWidth, gameAreaHeight);
        }
    }, 100);
});
</script>
</body>
</html>

