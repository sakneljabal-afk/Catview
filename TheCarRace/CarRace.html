<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متسابق المعرفة (نسخة مبسطة)</title>
<style>
    /* ------------------------------------------------------------
       تنسيقات الواجهة (كما هي، مع التركيز على RTL)
       ------------------------------------------------------------ */
  html,body { height:100%; margin:0; font-family: "Tahoma", "Arial", sans-serif; background:#cfeefc; }
  #game-container { width:100%; height:100vh; overflow:hidden; position:relative; }
  /* واجهة السؤال (overlay) */
  #questionModal {
    display:none;
    position:absolute;
    inset:10% 10% 15% 10%;
    background:rgba(255,255,255,0.97);
    border-radius:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.25);
    padding:18px;
    z-index:1000;
    direction:rtl;
  }
  #questionModal h2 { margin:0 0 8px 0; font-size:20px; color:#1b4f72; }
  #questionText { font-size:18px; margin-bottom:12px; color:#063047; }
  .optionBtn {
    display:block;
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:2px solid #1b4f72;
    background:#fff;
    font-size:16px;
    cursor:pointer;
    text-align:center;
    transition: background 0.1s;
  }
  .optionBtn:hover { background:#f0f8ff; }
  #closeInfo { margin-top:10px; font-size:14px; color:#666; text-align:center; }
  /* زوايا UI صغيرة لعرض السرعة */
  #hud {
    position:absolute;
    top:10px; left:10px; z-index:900;
    background:rgba(255,255,255,0.9);
    padding:8px 12px; border-radius:10px; font-size:14px; color:#033047;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    direction:rtl;
  }
  #instr {
    position:absolute;
    bottom:10px; left:10px; z-index:900;
    background:rgba(255,255,255,0.9);
    padding:8px 12px; border-radius:10px; font-size:13px; color:#033047;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    direction:rtl;
  }
</style>
</head>
<body>
<div id="game-container"></div>

<div id="questionModal" role="dialog" aria-modal="true">
  <h2>سؤال</h2>
  <div id="questionText"></div>
  <div id="options"></div>
  <div id="closeInfo">اضغط على اختيار للإجابة — الإجابة الصحيحة تزيد السرعة، الخاطئة تقللها وتعيد السؤال لاحقاً.</div>
</div>

<div id="hud">السرعة الأساسية: <span id="vbase">200</span> px/s</div>
<div id="instr">المسافة ستتولد تلقائياً. اضغط ↑ للقفز.</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
<script>
/* ------------------------------------------------------------
   بيانات الأسئلة
   ------------------------------------------------------------ */
const allQuestions = [
    {
        "q": "تعيش شجرة المانجروف في بيئة المياه المالحة، ولهذا تمتلك تكيفاً تركيبياً هو:",
        "c": [
            "أوراق عريضة تطفو على الماء",
            "جذور قصيرة ضعيفة",
            "جذور طويلة وقوية لمقاومة الأمواج"
        ],
        "a": 2
    },
    {
        "q": "ما هي وظيفة الجذور الطويلة والقوية لشجرة المانجروف؟",
        "c": [
            "تخزين كميات كبيرة من الماء",
            "امتصاص الضوء من سطح الماء",
            "الصمود أمام الأمواج القوية"
        ],
        "a": 2
    },
    {
        "q": "ما هو التكيف السلوكي الذي تقوم به سحلية العُرف لحماية نفسها؟",
        "c": [
            "تغيير لونها حسب البيئة",
            "نفخ جسمها لتبدو أكبر",
            "تدفن نفسها في الرمال"
        ],
        "a": 1
    },
];

/* ------------------------------------------------------------
   إعدادات اللعبة والسرعات
   ------------------------------------------------------------ */
let V_base = 200;         // السرعة الأساسية (px/s)
let V_scroll = V_base;    // سرعة التمرير الحالية
const SPAWN_BOX_INTERVAL = 2000; // محاولة إنشاء صندوق كل 2 ثانية
const RETRY_DELAY = 5000; // إعادة سؤال خاطئ بعد 5000 مللي ثانية
const GAME_WIDTH = window.innerWidth;
const GAME_HEIGHT = window.innerHeight;

// *** التبسيط: مستوى ثابت للأرض (سطح الأرض) ***
const GROUND_SURFACE_Y = GAME_HEIGHT * 0.8; 
const TERRAIN_TILE_WIDTH = 500; // عرض كبير لقطعة الأرض الواحدة

/* ------------------------------------------------------------
   إدارة قائمة الأسئلة (pool) وQueue للأسئلة الخاطئة
   ------------------------------------------------------------ */
let activeQuestionPool = [];   
let retryQueue = [];           

for (let i=0;i<allQuestions.length;i++) activeQuestionPool.push(i);

/* ------------------------------------------------------------
   عناصر DOM واجهة السؤال
   ------------------------------------------------------------ */
const qModal = document.getElementById('questionModal');
const qTextEl = document.getElementById('questionText');
const optionsEl = document.getElementById('options');
const vbaseEl = document.getElementById('vbase');

/* ------------------------------------------------------------
   إعداد Phaser 3
   ------------------------------------------------------------ */
const config = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: GAME_WIDTH,
  height: GAME_HEIGHT,
  backgroundColor: 0xcfeefc,
  physics: {
    default: 'arcade',
    arcade: {
      gravity: { y: 1000 },
      debug: false // اجعلها true لرؤية حدود الفيزياء
    }
  },
  scale: {
    mode: Phaser.Scale.RESIZE,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: {
    preload: preload,
    create: create,
    update: update
  }
};
const game = new Phaser.Game(config);

/* عناصر عالم اللعبة */
let player;
let groundGroup;     // قطع الأرض المتحركة
let boxesGroup;      // صناديق الأسئلة
let spawnTimer;      
let isPausedForQuestion = false;

function preload() {
  // تحميل صور وهمية (سيتم إنشاء ال textures لاحقًا)
  this.load.image('dummy', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=');
}

function create() {
  const scene = this;

  // إنشاء مجموعات فيزيائية
  groundGroup = this.physics.add.group({ allowGravity: false, immovable: true });
  boxesGroup = this.physics.add.group({ allowGravity: false, immovable: true });

  // نولّد نسيج السيارة
  const gfx = this.add.graphics();
  gfx.fillStyle(0xff3b3b, 1);
  gfx.fillRoundedRect(0, 0, 140, 60, 12);
  gfx.lineStyle(4, 0x000000, 0.4);
  gfx.strokeRoundedRect(0, 0, 140, 60, 12);
  gfx.fillStyle(0x111111, 1);
  gfx.fillCircle(28, 66, 18);
  gfx.fillCircle(112, 66, 18);
  gfx.generateTexture('carTex', 140, 90);
  gfx.clear();

  // نسيج صندوق السؤال
  const g2 = this.add.graphics();
  g2.fillStyle(0x1b4f72, 1);
  g2.fillRoundedRect(0,0,64,64,8);
  g2.lineStyle(3,0xffffff,1);
  g2.strokeRoundedRect(0,0,64,64,8);
  g2.fillStyle(0xffffff,1);
  g2.fillRect(10,26,44,8);
  g2.generateTexture('qbox', 64,64);
  g2.clear();

  // *** التبسيط: توليد الأرضية المستوية ***
  let x = 0;
  const tilesNeeded = Math.ceil(GAME_WIDTH / TERRAIN_TILE_WIDTH) + 2;
  for (let i=0;i<tilesNeeded;i++){
    createGroundTile.call(this, x, GROUND_SURFACE_Y);
    x += TERRAIN_TILE_WIDTH;
  }

  // إنشاء اللاعب (تم تعديل موضع Y ليتطابق مع سطح الأرض)
  const playerStartX = 180;
  player = this.physics.add.sprite(playerStartX, GROUND_SURFACE_Y, 'carTex');
  player.setOrigin(0.5, 1); // الـ Origin (0.5, 1) تعني أسفل مركز العنصر
  player.setCollideWorldBounds(true);
  player.setBodySize(120,50).setOffset(10,40);
  player.setBounce(0.02);

  // اصطدام مع الأرض
  this.physics.add.collider(player, groundGroup);

  // اصطدام / تداخل مع صناديق الأسئلة
  this.physics.add.overlap(player, boxesGroup, handleBoxCollision, null, this);

  // تحكمات القفز
  this.input.keyboard.on('keydown-UP', () => {
    if (player.body.touching.down) player.setVelocityY(-520);
  });

  // مؤقت توليد صناديق الأسئلة
  spawnTimer = this.time.addEvent({
    delay: SPAWN_BOX_INTERVAL,
    loop: true,
    callback: () => {
      if (!isPausedForQuestion) attemptSpawnBox.call(scene);
    }
  });

  // تحديث نص السرعة
  vbaseEl.textContent = Math.round(V_base);
}

/* ------------------------------------------------------------
   وظائف المساعدة
   ------------------------------------------------------------ */
// *** تم تبسيط إنشاء قطعة الأرض لتكون مستوية على ارتفاع ثابت ***
function createGroundTile(x, y) {
  // y هنا هي سطح الأرض
  const scene = game.scene.scenes[0];
  const g = scene.add.graphics();
  g.fillStyle(0x2d8f54,1);
  const tileW = TERRAIN_TILE_WIDTH;
  const tileH = GAME_HEIGHT - y; // الارتفاع يملأ الشاشة أسفل y
  
  g.fillRect(0,0,tileW,tileH);
  const key = 'ground_' + Phaser.Math.RND.uuid().substring(0,8);
  g.generateTexture(key, tileW, tileH);
  g.destroy();

  // مركز الصورة سيكون في منتصف العرض وعلى منتصف الارتفاع (y + tileH/2)
  const img = scene.physics.add.image(x + tileW/2, y + tileH/2, key);
  img.setOrigin(0.5);
  img.setImmovable(true);
  img.body.allowGravity = false;
  img.setVelocityX(-V_scroll);
  groundGroup.add(img);
  return img;
}

function attemptSpawnBox() {
  const scene = game.scene.scenes[0];
  const now = scene.time.now;

  // اختيار السؤال (من retryQueue أو active pool) - نفس المنطق السليم
  let chosenQIndex = null;
  for (let i=0;i<retryQueue.length;i++){
    if (retryQueue[i].spawnAt <= now){
      chosenQIndex = retryQueue[i].qIndex;
      retryQueue.splice(i,1);
      break;
    }
  }
  if (chosenQIndex === null) {
    if (activeQuestionPool.length === 0) return;
    const idx = Phaser.Math.Between(0, activeQuestionPool.length-1);
    chosenQIndex = activeQuestionPool[idx];
  }

  // توليد صندوق على ارتفاع ثابت فوق الأرضية
  const spawnX = GAME_WIDTH + 120;
  const boxHeight = 64; // ارتفاع الصندوق
  const boxY = GROUND_SURFACE_Y - (boxHeight / 2) - 10; // 10px فوق الأرض
  
  const box = scene.physics.add.image(spawnX, boxY, 'qbox');
  box.setImmovable(true);
  box.body.allowGravity = false;
  box.setData('qIndex', chosenQIndex);
  box.setVelocityX(-V_scroll);
  boxesGroup.add(box);
}

/* ------------------------------------------------------------
   منطق الاصطدام، عرض الأسئلة، والتحقق من الإجابة (كما هي)
   ------------------------------------------------------------ */
function handleBoxCollision(playerObj, boxObj) {
  if (isPausedForQuestion) return;
  isPausedForQuestion = true;

  V_scroll = 0;
  updateAllMovingObjectsVelocity(0);

  const qIndex = boxObj.getData('qIndex');
  showQuestionModal(qIndex, () => {});

  boxObj.destroy();
}

function showQuestionModal(qIndex, onShown) {
  const q = allQuestions[qIndex];
  qTextEl.textContent = q.q;
  optionsEl.innerHTML = '';

  q.c.forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.className = 'optionBtn';
    btn.textContent = `${idx + 1}. ${opt}`;
    btn.onclick = () => {
      checkAnswer(qIndex, idx);
    };
    optionsEl.appendChild(btn);
  });

  qModal.style.display = 'block';
  if (onShown) onShown();
}

function hideQuestionModal() {
  qModal.style.display = 'none';
}

function checkAnswer(qIndex, selectedOptionIndex) {
  const correctIndex = allQuestions[qIndex].a;
  const scene = game.scene.scenes[0];
  const now = scene.time.now;

  if (selectedOptionIndex === correctIndex) {
    // إجابة صحيحة
    V_base = V_base + 20;
    const pos = activeQuestionPool.indexOf(qIndex);
    if (pos !== -1) activeQuestionPool.splice(pos,1);
  } else {
    // إجابة خاطئة
    V_base = V_base * 0.6;
    retryQueue.push({ qIndex: qIndex, spawnAt: now + RETRY_DELAY });
    if (!activeQuestionPool.includes(qIndex)) activeQuestionPool.push(qIndex);
  }

  vbaseEl.textContent = Math.round(V_base);

  hideQuestionModal();
  isPausedForQuestion = false;
  resumeScrollingWithVbase();
}

function resumeScrollingWithVbase() {
  V_scroll = V_base;
  updateAllMovingObjectsVelocity(-V_scroll);
}

function updateAllMovingObjectsVelocity(velX) {
  groundGroup.getChildren().forEach(g => {
    g.setVelocityX(velX);
  });
  boxesGroup.getChildren().forEach(b => {
    b.setVelocityX(velX);
  });
}

/* ------------------------------------------------------------
   تحديث دوري: نستخدم منطق تدوير (Recycling) لقطع الأرض لتبسيط الكود
   ------------------------------------------------------------ */
function update(time, delta) {
  // تحديث سرعة جميع العناصر المتحركة في كل إطار
  if (!isPausedForQuestion) {
    V_scroll = V_base;
    updateAllMovingObjectsVelocity(-V_scroll);
  }
  
  // تدوير قطع الأرض (Recycling): عندما تخرج القطعة من الشاشة، انقلها إلى اليمين
  groundGroup.getChildren().forEach(g => {
    if (g.x + g.displayWidth / 2 < 0) {
      // انقلها إلى يمين آخر قطعة
      const maxX = groundGroup.getChildren().reduce((max, tile) => Math.max(max, tile.x + tile.displayWidth/2), 0);
      g.x = maxX + g.displayWidth/2;
      g.setVelocityX(-V_scroll); // أعد ضبط السرعة
    }
  });

  // إزالة الصناديق التي خرجت من الشاشة
  boxesGroup.getChildren().forEach(b => {
    if (b.x + b.displayWidth / 2 < 0) b.destroy();
  });
}
</script>
</body>
</html>
